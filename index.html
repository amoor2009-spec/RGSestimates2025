<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGS Scaffolding Calculator - Professional Estimation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(to right, #676c6c, #4a4e4e);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-box {
            background: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .logo-letters {
            display: flex;
            gap: 0.25rem;
        }

        .logo-letter {
            padding: 0.125rem 0.375rem;
            font-weight: bold;
            font-size: 0.875rem;
            color: white;
            border-radius: 0.25rem;
        }

        .logo-r { background-color: #676c6c; }
        .logo-g { background-color: #f97316; }
        .logo-s { background-color: #676c6c; }

        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .tab-list {
            display: flex;
            gap: 0.25rem;
        }

        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            color: #4b5563;
        }

        .tab-button:hover {
            color: #111827;
            background-color: #f9fafb;
        }

        .tab-button.active {
            color: #374151;
            border-bottom-color: #f97316;
            background-color: #f3f4f6;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            font-size: 1.125rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        .header-bar {
            width: 0.375rem;
            height: 1.5rem;
            margin-right: 0.75rem;
            border-radius: 0.25rem;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #6b7280;
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #f97316;
            color: white;
        }

        .btn-primary:hover {
            background-color: #ea580c;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-toggle {
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-toggle.active {
            background-color: #374151;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-toggle:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }

        .btn-toggle:not(.active):hover {
            background-color: #d1d5db;
        }

        /* Grid Layouts */
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-6 { grid-template-columns: repeat(6, 1fr); }

        /* Result Cards */
        .result-card {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: linear-gradient(to bottom right, var(--from-color), var(--to-color));
        }

        .result-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--label-color);
        }

        .result-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }

        /* Table Styles */
        table {
            width: 100%;
            font-size: 0.875rem;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
            background-color: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Info Box */
        .info-box {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid;
            font-size: 0.75rem;
        }

        .info-box-blue {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
        }

        .info-box-green {
            background-color: #d1fae5;
            border-color: #6ee7b7;
            color: #065f46;
        }

        .info-box-yellow {
            background-color: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .info-box-orange {
            background-color: #fed7aa;
            border-color: #fdba74;
            color: #9a3412;
        }

        /* Utility Classes */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: bold; }
        .font-semibold { font-weight: 600; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }

        /* Colors */
        .text-green-600 { color: #059669; }
        .text-orange-600 { color: #ea580c; }
        .text-red-600 { color: #dc2626; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }

        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-orange-50 { background-color: #fff7ed; }
        .bg-orange-100 { background-color: #fed7aa; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-100 { background-color: #d1fae5; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }

        /* Responsive */
        @media (min-width: 768px) {
            .form-grid { grid-template-columns: repeat(4, 1fr); }
            .grid-md-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-md-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-md-4 { grid-template-columns: repeat(4, 1fr); }
        }

        @media (min-width: 1024px) {
            .form-grid { grid-template-columns: repeat(6, 1fr); }
            .grid-lg-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-lg-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-lg-5 { grid-template-columns: repeat(5, 1fr); }
        }

        /* Dynamic grid for results */
        .result-grid-3 { grid-template-columns: repeat(3, 1fr) !important; }
        .result-grid-4 { grid-template-columns: repeat(4, 1fr) !important; }

        @media (max-width: 768px) {
            .result-grid-3,
            .result-grid-4 { grid-template-columns: repeat(2, 1fr) !important; }
        }

        @media (max-width: 480px) {
            .result-grid-3,
            .result-grid-4 { grid-template-columns: 1fr !important; }
        }

        /* Icons (simplified) */
        .icon {
            width: 1rem;
            height: 1rem;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-sm {
            width: 0.75rem;
            height: 0.75rem;
        }

        .icon-lg {
            width: 2rem;
            height: 2rem;
        }

        /* Print Styles */
        @media print {
            body { background: white; }
            .header, .tab-nav, .btn { display: none; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; }
        }

        /* Additional styles for BOQ */
        .boq-hire-input {
            width: 5rem;
            padding: 0.25rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            background-color: #fff7ed;
            font-size: 0.75rem;
        }

        .boq-hire-input:focus {
            outline: none;
            border-color: #fb923c;
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.2);
        }

        .discount-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            font-size: 0.625rem;
            font-weight: 600;
            color: #dc2626;
            background-color: #fee2e2;
            border-radius: 0.25rem;
            margin-left: 0.25rem;
        }

        /* Cash flow chart styles */
        #cash-flow-chart {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #cash-flow-chart > div > div[title] {
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        #cash-flow-chart > div > div[title]:hover {
            opacity: 1;
        }

        /* Responsive table */
        @media (max-width: 768px) {
            #cash-flow-table {
                font-size: 0.75rem;
            }
            
            #cash-flow-table th,
            #cash-flow-table td {
                padding: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo-box">
                            <div class="logo-letters">
                                <span class="logo-letter logo-r">R</span>
                                <span class="logo-letter logo-g">G</span>
                                <span class="logo-letter logo-s">S</span>
                            </div>
                        </div>
                        <div>
                            <h1 style="font-size: 1.5rem; font-weight: bold;">RGS Scaffolding Calculator</h1>
                            <p style="font-size: 0.75rem; color: #d1d5db;">Your Scaffolding Partner - Intelligent Material Calculation & Cost Estimation</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button class="btn btn-primary" onclick="resetAll()">
                            <span>↻</span> Reset
                        </button>
                        <div style="text-align: right;">
                            <p style="font-weight: 600; font-size: 0.875rem;">RGS - Resa Gulf Scaffolding Co. Ltd.</p>
                            <p style="font-size: 0.75rem; color: #d1d5db;">info@rgsksa.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <div class="container">
                <div class="tab-list">
                    <button class="tab-button active" onclick="switchTab('calculator')">
                        <span>🧮</span> Calculator
                    </button>
                    <button class="tab-button" onclick="switchTab('boq')">
                        <span>📋</span> BOQ & Analysis
                    </button>
                    <button class="tab-button" onclick="switchTab('workforce')">
                        <span>👥</span> Workforce Planning
                    </button>
                    <button class="tab-button" onclick="switchTab('dashboard')">
                        <span>📊</span> Dashboard
                    </button>
                    <button class="tab-button" onclick="switchTab('reports')">
                        <span>👁</span> Reports
                    </button>
                    <button class="tab-button" onclick="switchTab('settings')">
                        <span>⚙️</span> Settings
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container" style="padding: 1.5rem 1rem;">
            <!-- Calculator Tab -->
            <div id="calculator-tab" class="tab-content">
                <!-- Project Information -->
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #4b5563;"></span>
                        Project Information
                    </h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Client Name</label>
                            <input type="text" class="form-input" id="clientName" placeholder="Enter client" oninput="debounceCalculate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Project Name</label>
                            <input type="text" class="form-input" id="projectName" placeholder="Enter project" oninput="debounceCalculate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" id="location" placeholder="Enter location" oninput="debounceCalculate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="date" onchange="calculateAll()">
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="productivityLabel">Productivity (m³/hr)</label>
                            <input type="number" step="0.1" class="form-input" id="productivityRate" value="2.5" onchange="calculateAll()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Size</label>
                            <input type="number" class="form-input" id="teamSize" value="4" onchange="calculateAll()">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <strong>Working Schedule:</strong> 10 hours/day, 6 days/week • Productivity rate is per hour per scaffolder
                    </p>
                </div>

                <!-- Scaffolding Type & Dimensions -->
                <div class="card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <h2 class="card-header">
                                <span class="header-bar" style="background-color: #f97316;"></span>
                                Scaffolding Type
                            </h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="scaffolding-type-btn active" onclick="selectScaffoldingType('birdcage')" data-type="birdcage">
                                    <strong style="font-size: 0.875rem;">Birdcage</strong>
                                    <p style="font-size: 0.75rem; color: #4b5563;">Full scaffold</p>
                                </button>
                                <button class="scaffolding-type-btn" onclick="selectScaffoldingType('tower')" data-type="tower">
                                    <strong style="font-size: 0.875rem;">Tower</strong>
                                    <p style="font-size: 0.75rem; color: #4b5563;">Vertical access</p>
                                </button>
                                <button class="scaffolding-type-btn" onclick="selectScaffoldingType('independent')" data-type="independent">
                                    <strong style="font-size: 0.875rem;">Independent</strong>
                                    <p style="font-size: 0.75rem; color: #4b5563;">Perimeter</p>
                                </button>
                                <button class="scaffolding-type-btn" onclick="selectScaffoldingType('suspended')" data-type="suspended">
                                    <strong style="font-size: 0.875rem;">Suspended</strong>
                                    <p style="font-size: 0.75rem; color: #4b5563;">Hanging</p>
                                </button>
                            </div>
                            <div class="info-box info-box-blue mt-3">
                                <p><strong>Material Return % (MR%):</strong> This critical metric shows what percentage of your purchase investment you recover from this <span id="mr-hire-days">30</span>-day project.</p>
                                <p class="text-xs mt-1"><strong>Note:</strong> Hire Rate Adjustment % applies only to hire rates, not purchase prices. Use individual hire rate fields in BOQ for specific item discounts.</p>
                            </div>
                        </div>
                        <div>
                            <h2 class="card-header">
                                <span class="header-bar" style="background-color: #4b5563;"></span>
                                Dimensions & Settings
                            </h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div class="form-group">
                                    <label class="form-label" id="length-label">Length (m)</label>
                                    <input type="number" class="form-input" id="length" placeholder="0.00" onchange="calculateAll()">
                                </div>
                                <div class="form-group" id="width-group">
                                    <label class="form-label">Width (m)</label>
                                    <input type="number" class="form-input" id="width" placeholder="0.00" onchange="calculateAll()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" id="height-label">Height (m)</label>
                                    <input type="number" class="form-input" id="height" placeholder="0.00" onchange="calculateAll()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center;">
                                        <span style="color: #f97316; margin-right: 0.25rem;">⏱</span>
                                        Hire Duration (days)
                                    </label>
                                    <input type="number" class="form-input" id="hireDuration" value="30" style="background-color: #fff7ed; border-color: #fb923c;" onchange="calculateAll()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center;">
                                        <span style="color: #10b981; margin-right: 0.25rem;">%</span>
                                        Hire Rate Adjustment (%)
                                    </label>
                                    <input type="number" step="0.5" class="form-input" id="marketAdjustment" value="0" style="background-color: #f0fdf4; border-color: #34d399;" onchange="calculateAll()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Days</label>
                                    <input type="number" class="form-input" id="projectDuration" placeholder="Auto" onchange="calculateAll()">
                                </div>
                            </div>
                            <div id="dimension-note" class="hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Indirect Personnel -->
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #8b5cf6;"></span>
                        Indirect Personnel & Rates
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem;">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center;">
                                <input type="checkbox" id="inspector-enabled" checked style="margin-right: 0.25rem;" onchange="calculateAll()">
                                Inspector
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" class="form-input" id="inspector-rate" value="45" placeholder="Rate" style="width: 4rem;" onchange="calculateAll()">
                                <input type="number" class="form-input" id="inspector-qty" value="1" placeholder="Qty" style="width: 3rem;" onchange="calculateAll()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center;">
                                <input type="checkbox" id="supervisor-enabled" checked style="margin-right: 0.25rem;" onchange="calculateAll()">
                                Supervisor
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" class="form-input" id="supervisor-rate" value="50" placeholder="Rate" style="width: 4rem;" onchange="calculateAll()">
                                <input type="number" class="form-input" id="supervisor-qty" placeholder="Auto" style="width: 3rem;" onchange="calculateAll()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center;">
                                <input type="checkbox" id="hseOfficer-enabled" checked style="margin-right: 0.25rem;" onchange="calculateAll()">
                                HSE Officer
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" class="form-input" id="hseOfficer-rate" value="40" placeholder="Rate" style="width: 4rem;" onchange="calculateAll()">
                                <input type="number" class="form-input" id="hseOfficer-qty" value="1" placeholder="Qty" style="width: 3rem;" onchange="calculateAll()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center;">
                                <input type="checkbox" id="permitReceiver-enabled" checked style="margin-right: 0.25rem;" onchange="calculateAll()">
                                Permit Receiver
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" class="form-input" id="permitReceiver-rate" value="35" placeholder="Rate" style="width: 4rem;" onchange="calculateAll()">
                                <input type="number" class="form-input" id="permitReceiver-qty" value="1" placeholder="Qty" style="width: 3rem;" onchange="calculateAll()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center;">
                                <input type="checkbox" id="projectLeader-enabled" checked style="margin-right: 0.25rem;" onchange="calculateAll()">
                                Project Leader
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" class="form-input" id="projectLeader-rate" value="60" placeholder="Rate" style="width: 4rem;" onchange="calculateAll()">
                                <input type="number" class="form-input" id="projectLeader-qty" value="1" placeholder="Qty" style="width: 3rem;" onchange="calculateAll()">
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <strong>Note:</strong> Rates are per hour. Working schedule: 10 hours/day, 6 days/week. Indirect personnel work the same hours as scaffolders.
                    </p>
                </div>

                <!-- Calculation Results -->
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #f97316;"></span>
                        Calculation Results
                    </h2>
                    
                    <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem;" class="result-grid-4">
                        <div class="result-card" id="volume-card" style="--from-color: #f3f4f6; --to-color: #e5e7eb;">
                            <p class="result-label" style="--label-color: #4b5563;">Volume</p>
                            <p class="result-value" id="result-volume">0 m³</p>
                        </div>
                        <div class="result-card" id="base-area-card" style="--from-color: #eff6ff; --to-color: #dbeafe;">
                            <p class="result-label" style="--label-color: #2563eb;" id="area-label">Base Area</p>
                            <p class="result-value" id="result-area">0 m²</p>
                        </div>
                        <div class="result-card" style="--from-color: #fff7ed; --to-color: #fed7aa;">
                            <p class="result-label" style="--label-color: #ea580c;">Manhours</p>
                            <p class="result-value" id="result-manhours">0 hrs</p>
                            <p class="text-xs text-gray-500">Scaffolders only</p>
                        </div>
                        <div class="result-card" style="--from-color: #e5e7eb; --to-color: #d1d5db;">
                            <p class="result-label" style="--label-color: #374151;">Total Cost</p>
                            <p class="result-value" id="result-totalcost">SAR 0.00</p>
                        </div>
                    </div>

                    <div class="bg-gray-50" style="padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h3 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Unit Rates per <span id="unit-rate-unit">m³</span></h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                            <div style="background: white; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e5e7eb;">
                                <p class="text-xs text-gray-600">Material Rate (<span id="cost-option-label">hire</span>)</p>
                                <p style="font-size: 1.125rem; font-weight: bold; color: #1f2937;" id="material-unit-rate">SAR 0.00</p>
                                <p class="text-xs text-orange-600 mt-1" id="daily-material-rate">Daily: SAR 0.00</p>
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e5e7eb;">
                                <p class="text-xs text-gray-600">Installation Rate</p>
                                <p style="font-size: 1.125rem; font-weight: bold; color: #1f2937;" id="installation-unit-rate">SAR 0.00</p>
                                <div class="text-xs text-gray-500 mt-1">
                                    🔧 All installation costs
                                </div>
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e5e7eb;">
                                <p class="text-xs text-gray-600">Total Unit Rate</p>
                                <p style="font-size: 1.125rem; font-weight: bold; color: #4338ca;" id="total-unit-rate">SAR 0.00</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                        <div class="bg-gray-50" style="padding: 0.75rem; border-radius: 0.5rem;">
                            <p class="text-xs font-medium text-gray-600">Material Cost (<span id="cost-option-label2">hire</span>)</p>
                            <p style="font-size: 1.125rem; font-weight: bold; color: #1f2937;" id="material-cost">SAR 0.00</p>
                            <p class="text-xs text-gray-500 mt-1">
                                For <span class="text-orange-600 font-semibold" id="hire-duration-display">30 days</span>
                                <span id="market-adjustment-display"></span>
                            </p>
                            <div class="mt-2" style="padding-top: 0.5rem; border-top: 1px solid #d1d5db;">
                                <p class="text-xs text-gray-600">Purchase Cost/Ton</p>
                                <p style="font-size: 0.875rem; font-weight: bold; color: #065f46;" id="purchase-per-ton">SAR 0.00</p>
                            </div>
                        </div>
                        <div class="bg-gray-50" style="padding: 0.75rem; border-radius: 0.5rem;">
                            <p class="text-xs font-medium text-gray-600">Material Return %</p>
                            <p style="font-size: 1.25rem; font-weight: bold;" id="mr-percentage" class="text-green-600">0%</p>
                            <p class="text-xs text-gray-500 mt-1">Project ROI if Purchased</p>
                        </div>
                        <div class="bg-gray-50" style="padding: 0.75rem; border-radius: 0.5rem;">
                            <p class="text-xs font-medium text-gray-600">Total Weight</p>
                            <p style="font-size: 1.125rem; font-weight: bold; color: #1f2937;" id="total-weight">0 Tons</p>
                            <p class="text-xs text-gray-500 mt-1" id="total-weight-kg">0 Kg</p>
                        </div>
                    </div>

                    <div class="info-box info-box-blue mt-3">
                        <p class="text-xs">
                            <strong>Material Return % (MR%) Explained:</strong> This shows what percentage of your purchase investment you recover from this <span id="mr-project-days">30</span>-day project.
                            <span id="mr-explanation"></span>
                        </p>
                        <p class="text-xs mt-1" id="mr-decision-guide"></p>
                        <p class="text-xs mt-1" id="mr-break-even"></p>
                    </div>
                </div>
            </div>

            <!-- BOQ Tab -->
            <div id="boq-tab" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #f97316;"></span>
                        Material Cost Calculation Method
                    </h2>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn-toggle active" id="hire-btn" onclick="setCostOption('hire')">Calculate as Hire</button>
                            <button class="btn-toggle" id="purchase-btn" onclick="setCostOption('purchase')">Calculate as Purchase</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="bg-orange-100" style="border-radius: 0.5rem; padding: 0.375rem 0.75rem; display: flex; align-items: center;" id="hire-duration-badge">
                                <span style="color: #ea580c; margin-right: 0.375rem;">⏱</span>
                                <p class="text-xs text-gray-700">
                                    <strong>Hire:</strong> <span class="text-orange-600 font-bold" id="hire-duration-badge-days">30 days</span>
                                </p>
                            </div>
                            <div class="bg-green-100" style="border-radius: 0.5rem; padding: 0.375rem 0.75rem; display: flex; align-items: center;" id="market-adjustment-badge">
                                <span style="color: #059669; margin-right: 0.375rem;">%</span>
                                <p class="text-xs text-gray-700">
                                    <strong>Hire Adj:</strong> <span class="text-green-600 font-bold" id="market-adjustment-badge-value">+0%</span>
                                </p>
                            </div>
                            <div class="bg-gray-100" style="border-radius: 0.5rem; padding: 0.375rem 0.75rem; display: flex; align-items: center;">
                                <span style="color: #4b5563; margin-right: 0.375rem;">⚖</span>
                                <p class="text-xs text-gray-700">
                                    <strong>Weight:</strong> <span class="text-gray-600 font-bold" id="total-weight-badge">0 Tons</span>
                                </p>
                            </div>
                            <div class="bg-blue-100" style="border-radius: 0.5rem; padding: 0.375rem 0.75rem; display: flex; align-items: center;">
                                <span style="color: #2563eb; margin-right: 0.375rem;">💰</span>
                                <p class="text-xs text-gray-700">
                                    <strong>Purchase/Ton:</strong> <span class="text-blue-600 font-bold" id="purchase-per-ton-badge">SAR 0.00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h2 class="card-header" style="margin-bottom: 0;">
                            <span class="header-bar" style="background-color: #f97316;"></span>
                            Bill of Quantities - <span id="boq-scaffolding-type">Birdcage</span> Scaffolding
                        </h2>
                        <button class="btn btn-primary" onclick="addBoqItem()">
                            <span>+</span> Add Item
                        </button>
                    </div>
                    
                    <div id="scaffolding-type-note" class="info-box info-box-yellow mb-3"></div>
                    
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center">S/N</th>
                                    <th>Description</th>
                                    <th class="text-center">Code</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-center">Length</th>
                                    <th class="text-center">Unit Wt</th>
                                    <th class="text-center">Total Wt</th>
                                    <th class="text-center">Purchase<br><span style="font-weight: normal; font-size: 0.625rem;">(SAR/unit)</span></th>
                                    <th class="text-center">Hire/Day<br><span style="font-weight: normal; font-size: 0.625rem;">(Editable)</span></th>
                                    <th class="text-center">Days</th>
                                    <th class="text-right">Total</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="boq-items">
                                <!-- BOQ items will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background-color: #f3f4f6;">
                                    <td colspan="6" class="text-right">Total Weight (Kg):</td>
                                    <td class="text-center" id="boq-total-weight">0</td>
                                    <td colspan="3" class="text-right">Total Amount:</td>
                                    <td class="text-right" id="boq-total-amount">SAR 0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #4b5563;"></span>
                        Material Return Analysis (Purchase Investment ROI)
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="text-center">
                            <div style="font-size: 3rem; font-weight: bold;" id="mr-percentage-large" class="text-green-600">0%</div>
                            <p class="text-sm text-gray-600">Project Return Rate</p>
                            <p class="text-xs text-gray-500 mt-1">Total Hire Revenue ÷ Purchase Cost × 100</p>
                            <div class="bg-gray-100" style="padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem;">
                                <p class="text-xs text-gray-600">Projects to break-even</p>
                                <p style="font-size: 1.5rem; font-weight: bold;" id="mr-projects-breakeven" class="text-green-600">N/A</p>
                                <p class="text-xs text-gray-600">similar projects</p>
                                <div style="margin-top: 0.5rem;">
                                    <div style="width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 0.5rem;">
                                        <div id="mr-progress-bar" style="height: 0.5rem; border-radius: 9999px; width: 0%; background-color: #10b981;"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">ROI Progress</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="text-sm text-gray-600">Investment Recovery:</span>
                                <span class="font-bold" id="mr-recovery-status">Multiple Projects Needed</span>
                            </div>
                            <div class="bg-gray-100" style="padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span class="text-gray-600">Project Hire Revenue (<span id="mr-project-days2">30</span> days)</span>
                                    <span class="font-semibold" id="mr-project-revenue">SAR 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span class="text-gray-600">Daily Hire Revenue</span>
                                    <span class="font-semibold text-green-600" id="mr-daily-revenue">SAR 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span class="text-gray-600">Total Purchase Cost</span>
                                    <span class="font-semibold" id="mr-purchase-cost">SAR 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: bold; padding-top: 0.5rem; border-top: 1px solid #d1d5db;">
                                    <span class="text-gray-700">Projects to Break Even</span>
                                    <span id="mr-projects-needed" class="text-green-600">N/A projects</span>
                                </div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #d1d5db; margin-top: 0.5rem;">
                                    <p class="text-xs text-gray-600" id="mr-analysis"></p>
                                </div>
                                <div class="info-box info-box-yellow mt-2">
                                    <p class="text-xs" id="mr-recommendation"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workforce Tab -->
            <div id="workforce-tab" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #4b5563;"></span>
                        Workforce Requirements
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div class="result-card" style="--from-color: #d1fae5; --to-color: #6ee7b7; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 2rem;">👥</span>
                                <span style="font-size: 1.5rem; font-weight: bold; color: #1f2937;" id="workforce-scaffolders">0</span>
                            </div>
                            <p style="font-size: 0.875rem; font-weight: 500; color: #059669;">Scaffolders Required</p>
                            <p class="text-xs" style="color: #047857; margin-top: 0.25rem;">Based on <span id="workforce-team-size">4</span> workers per team</p>
                        </div>
                        <div class="result-card" style="--from-color: #f3f4f6; --to-color: #e5e7eb; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 2rem;">📈</span>
                                <span style="font-size: 1.5rem; font-weight: bold; color: #1f2937;" id="workforce-teams">0</span>
                            </div>
                            <p style="font-size: 0.875rem; font-weight: 500; color: #374151;">Teams Required</p>
                            <p class="text-xs text-gray-600" style="margin-top: 0.25rem;">To complete in <span id="workforce-days">0</span> days</p>
                        </div>
                        <div class="result-card" style="--from-color: #ede9fe; --to-color: #c7d2fe; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 2rem;">📅</span>
                                <span style="font-size: 1.5rem; font-weight: bold; color: #1f2937;" id="workforce-project-days">0</span>
                            </div>
                            <p style="font-size: 0.875rem; font-weight: 500; color: #7c3aed;">Project Duration (Days)</p>
                            <p class="text-xs text-gray-600" style="margin-top: 0.25rem;">10 hrs/day, 6 days/week</p>
                        </div>
                    </div>

                    <div class="bg-gray-50" style="padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                        <h3 style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.75rem;">Workforce Planning Details</h3>
                        <div id="workforce-details" style="font-size: 0.875rem;">
                            <!-- Workforce details will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Progressive Installation & Cash Flow Analysis -->
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #10b981;"></span>
                        Progressive Installation & Cash Flow Analysis
                    </h2>
                    
                    <!-- Project Phases Overview -->
                    <div style="background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h3 class="font-semibold text-sm mb-3">Project Phases Timeline</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                            <div style="background-color: #fff7ed; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #fed7aa;">
                                <h4 class="font-semibold text-sm" style="color: #ea580c;">📦 Installation Phase</h4>
                                <p class="text-xs mt-1">Duration: <span id="installation-days" class="font-bold">0</span> days</p>
                                <p class="text-xs">• Full workforce deployment</p>
                                <p class="text-xs">• Material delivery & installation</p>
                                <p class="text-xs">• No hire revenue until handover</p>
                                <p class="text-xs text-red-600 font-semibold">⚠ High cost, limited revenue</p>
                            </div>
                            <div style="background-color: #f0fdf4; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #6ee7b7;">
                                <h4 class="font-semibold text-sm" style="color: #059669;">💰 Hire Phase</h4>
                                <p class="text-xs mt-1">Duration: <span id="hire-phase-days" class="font-bold">30</span> days</p>
                                <p class="text-xs">• Minimal supervision only</p>
                                <p class="text-xs">• Full hire revenue active</p>
                                <p class="text-xs">• Periodic inspections</p>
                                <p class="text-xs text-green-600 font-semibold">✓ Low cost, maximum revenue</p>
                            </div>
                            <div style="background-color: #fee2e2; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #fca5a5;">
                                <h4 class="font-semibold text-sm" style="color: #dc2626;">🔧 Dismantling Phase</h4>
                                <p class="text-xs mt-1">Duration: <span id="dismantling-days" class="font-bold">0</span> days</p>
                                <p class="text-xs">• Full workforce required</p>
                                <p class="text-xs">• Material removal & return</p>
                                <p class="text-xs">• No revenue generation</p>
                                <p class="text-xs text-red-600 font-semibold">⚠ High cost, no revenue</p>
                            </div>
                        </div>
                        <div class="info-box info-box-blue mt-3">
                            <p class="text-xs"><strong>Important:</strong> Revenue recognition follows industry standards - hire billing starts only after successful inspection and handover. Installation service revenue is typically paid 70% during progress and 30% upon completion.</p>
                        </div>
                    </div>
                    
                    <!-- Time Period Selection -->
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Analysis Period:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-toggle active" id="weekly-btn" onclick="setProgressPeriod('weekly')">Weekly</button>
                            <button class="btn-toggle" id="monthly-btn" onclick="setProgressPeriod('monthly')">Monthly</button>
                        </div>
                    </div>

                    <!-- Progress Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                        <div class="result-card" style="--from-color: #f0fdf4; --to-color: #d1fae5; padding: 0.75rem;">
                            <p class="text-xs text-gray-600">Daily Progress</p>
                            <p style="font-size: 1rem; font-weight: bold; color: #1f2937;" id="daily-progress">0 m³/day</p>
                        </div>
                        <div class="result-card" style="--from-color: #eff6ff; --to-color: #dbeafe; padding: 0.75rem;">
                            <p class="text-xs text-gray-600">Weekly Progress</p>
                            <p style="font-size: 1rem; font-weight: bold; color: #1f2937;" id="weekly-progress">0 m³/week</p>
                        </div>
                        <div class="result-card" style="--from-color: #fff7ed; --to-color: #fed7aa; padding: 0.75rem;">
                            <p class="text-xs text-gray-600">Installation Daily Cost</p>
                            <p style="font-size: 1rem; font-weight: bold; color: #1f2937;" id="daily-cost">SAR 0.00</p>
                        </div>
                        <div class="result-card" style="--from-color: #fef3c7; --to-color: #fde68a; padding: 0.75rem;">
                            <p class="text-xs text-gray-600">Hire Daily Revenue</p>
                            <p style="font-size: 1rem; font-weight: bold; color: #1f2937;" id="daily-revenue">SAR 0.00</p>
                        </div>
                    </div>

                    <!-- Cash Flow Table -->
                    <div style="overflow-x: auto;">
                        <table class="text-sm">
                            <thead>
                                <tr>
                                    <th class="text-center">Period</th>
                                    <th class="text-center">Days</th>
                                    <th class="text-center">Progress<br><span class="text-xs font-normal">(<span id="progress-unit">m³</span>)</span></th>
                                    <th class="text-center">Cumulative<br><span class="text-xs font-normal">(<span id="progress-unit2">m³</span>)</span></th>
                                    <th class="text-center">Progress<br><span class="text-xs font-normal">(%)</span></th>
                                    <th class="text-right">Material Cost<br><span class="text-xs font-normal">(SAR)</span></th>
                                    <th class="text-right">Labor Cost<br><span class="text-xs font-normal">(SAR)</span></th>
                                    <th class="text-right">Other Costs<br><span class="text-xs font-normal">(SAR)</span></th>
                                    <th class="text-right">Total Cost<br><span class="text-xs font-normal">(SAR)</span></th>
                                    <th class="text-right">Revenue<br><span class="text-xs font-normal">(SAR)</span></th>
                                    <th class="text-right">Cash Flow<br><span class="text-xs font-normal">(SAR)</span></th>
                                    <th class="text-right">Cumulative CF<br><span class="text-xs font-normal">(SAR)</span></th>
                                </tr>
                            </thead>
                            <tbody id="cash-flow-table">
                                <!-- Cash flow rows will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background-color: #f3f4f6;">
                                    <td colspan="4" class="text-right">Total:</td>
                                    <td class="text-center" id="cf-total-progress">100%</td>
                                    <td class="text-right" id="cf-total-material">SAR 0.00</td>
                                    <td class="text-right" id="cf-total-labor">SAR 0.00</td>
                                    <td class="text-right" id="cf-total-other">SAR 0.00</td>
                                    <td class="text-right" id="cf-total-cost">SAR 0.00</td>
                                    <td class="text-right" id="cf-total-revenue">SAR 0.00</td>
                                    <td class="text-right" id="cf-total-cashflow">SAR 0.00</td>
                                    <td class="text-right" id="cf-final-cumulative">SAR 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Cash Flow Chart -->
                    <div class="bg-gray-50" style="padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                        <h3 style="font-weight: 600; font-size: 1rem; margin-bottom: 0.75rem;">Cash Flow Visualization by Phase</h3>
                        <div id="cash-flow-chart" style="position: relative; min-height: 350px;">
                            <!-- Phase-based chart will be inserted here -->
                        </div>
                    </div>

                    <!-- Project Control Insights -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                        <div class="info-box info-box-green">
                            <h4 class="font-semibold text-sm mb-2">Revenue Recognition</h4>
                            <div id="revenue-insights" class="text-xs">
                                <!-- Revenue insights will be inserted here -->
                            </div>
                        </div>
                        <div class="info-box info-box-yellow">
                            <h4 class="font-semibold text-sm mb-2">Cost Control Alerts</h4>
                            <div id="cost-control-alerts" class="text-xs">
                                <!-- Cost control alerts will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #f97316;"></span>
                        Project Decision Dashboard
                    </h2>
                    
                    <div id="dashboard-decision-box" style="padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <!-- Decision box will be inserted here -->
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="result-card" style="--from-color: #f3f4f6; --to-color: #e5e7eb; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span>📊</span>
                                <span class="text-xs font-medium text-gray-600 bg-gray-300" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Unit Rate</span>
                            </div>
                            <p style="font-size: 1.25rem; font-weight: bold; color: #1f2937;" id="dashboard-unit-rate">SAR 0.00</p>
                            <p class="text-xs text-gray-600 mt-1">per <span id="dashboard-unit">m³</span></p>
                        </div>

                        <div class="result-card" style="--from-color: #f0fdf4; --to-color: #d1fae5; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span>💹</span>
                                <span class="text-xs font-medium text-green-600 bg-green-200" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Profit</span>
                            </div>
                            <p style="font-size: 1.25rem; font-weight: bold; color: #1f2937;" id="dashboard-profit">SAR 0.00</p>
                            <p class="text-xs text-gray-600 mt-1"><span id="dashboard-profit-margin">15</span>% margin</p>
                        </div>

                        <div class="result-card" style="--from-color: #fff7ed; --to-color: #fed7aa; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span>📅</span>
                                <span class="text-xs font-medium text-orange-600 bg-orange-200" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Duration</span>
                            </div>
                            <p style="font-size: 1.25rem; font-weight: bold; color: #1f2937;" id="dashboard-days">0 days</p>
                            <p class="text-xs text-gray-600 mt-1"><span id="dashboard-workforce">0</span> total workforce</p>
                        </div>

                        <div id="dashboard-mr-card" class="result-card" style="padding: 1rem;">
                            <!-- MR% card will be inserted here -->
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="bg-gray-50" style="padding: 1rem; border-radius: 0.5rem;">
                            <h3 style="font-weight: bold; font-size: 1.125rem; margin-bottom: 0.75rem; color: #1f2937;">Cost Breakdown</h3>
                            <div id="cost-breakdown" style="font-size: 0.875rem;">
                                <!-- Cost breakdown will be inserted here -->
                            </div>
                        </div>

                        <div class="bg-gray-50" style="padding: 1rem; border-radius: 0.5rem;">
                            <h3 style="font-weight: bold; font-size: 1.125rem; margin-bottom: 0.75rem; color: #1f2937;">Unit Rate Analysis</h3>
                            <div id="unit-rate-analysis" style="font-size: 0.875rem;">
                                <!-- Unit rate analysis will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #4b5563;"></span>
                        Report Generation
                    </h2>
                    
                    <!-- Report Serial Number -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label class="form-label" style="margin-bottom: 0;">Report Serial Number:</label>
                            <input type="text" class="form-input" id="reportSerialNumber" style="width: 200px;" placeholder="Auto-generated" readonly>
                            <button class="btn btn-secondary btn-sm" onclick="generateSerialNumber()" style="padding: 0.25rem 0.5rem;">
                                <span>↻</span> New
                            </button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label class="form-label" style="margin-bottom: 0;">Type:</label>
                            <select class="form-select" id="reportType" style="width: 150px;" onchange="updateReportTypeSettings()">
                                <option value="internal">Internal Report</option>
                                <option value="quotation">Quotation/Offer</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Scope of Work -->
                    <div class="card" style="background-color: #f9fafb; padding: 1rem; margin-bottom: 1rem;">
                        <h3 class="font-semibold text-sm mb-2">Scope of Work</h3>
                        <textarea id="scopeOfWork" class="form-input" rows="4" placeholder="Enter the scope of work for this project..." style="width: 100%; resize: vertical;">1. Supply and installation of scaffolding materials as per project requirements
2. Inspection and certification of installed scaffolding
3. Maintenance during the hire period
4. Dismantling and removal after project completion</textarea>
                        <p class="text-xs text-gray-500 mt-1">Describe the work to be performed, deliverables, and any special requirements</p>
                    </div>
                    
                    <div style="background: linear-gradient(to right, #f9fafb, #f3f4f6); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h3 style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.75rem;">Report Preview</h3>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                            <div id="report-preview">
                                <!-- Report preview will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50" style="padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h3 class="font-semibold text-sm mb-3">Select Report Contents</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="report-project-info" checked style="margin-right: 0.5rem;">
                                    <span class="text-sm text-gray-700">Project Information & Dimensions</span>
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="report-cost-breakdown" checked style="margin-right: 0.5rem;">
                                    <span class="text-sm text-gray-700">Complete Cost Breakdown</span>
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="report-workforce" checked style="margin-right: 0.5rem;">
                                    <span class="text-sm text-gray-700">Workforce Planning Details</span>
                                </label>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="report-boq" checked style="margin-right: 0.5rem;">
                                    <span class="text-sm text-gray-700">Bill of Quantities</span>
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="report-unit-rates" checked style="margin-right: 0.5rem;">
                                    <span class="text-sm text-gray-700">Unit Rate Analysis</span>
                                </label>
                                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;" id="mr-analysis-option">
                                    <input type="checkbox" id="report-mr-analysis" checked style="margin-right: 0.5rem;">
                                    <span class="text-sm text-gray-700">Material Return Analysis (MR%)</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                            <button class="btn btn-secondary btn-sm" onclick="selectAllReportSections()" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                                Select All
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="deselectAllReportSections()" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; margin-left: 0.5rem;">
                                Deselect All
                            </button>
                        </div>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="card" style="background-color: #f9fafb; padding: 1rem; margin-bottom: 1rem;">
                        <h3 class="font-semibold text-sm mb-2">Terms and Conditions</h3>
                        <textarea id="termsConditions" class="form-input" rows="5" placeholder="Enter terms and conditions for the contract..." style="width: 100%; resize: vertical;">1. Payment Terms: 30% advance, 70% upon completion
2. Validity: This quotation is valid for 30 days from the date of issue
3. Delivery: Materials will be delivered within 7 working days after confirmation
4. Safety: All work will be carried out in accordance with local safety regulations
5. Insurance: Client to provide adequate insurance coverage for the project</textarea>
                        <p class="text-xs text-gray-500 mt-1">These terms will be included in quotation/offer reports only</p>
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-secondary" onclick="generateReport()">
                            <span>📄</span> Generate PDF
                        </button>
                        <button class="btn btn-primary" onclick="exportToExcel()">
                            <span>📊</span> Export to Excel
                        </button>
                        <button class="btn btn-secondary" onclick="emailReport()">
                            <span>✉️</span> Email Report
                        </button>
                        <button class="btn btn-secondary" onclick="printReport()">
                            <span>🖨️</span> Print
                        </button>
                    </div>

                    <div class="info-box info-box-blue mt-4">
                        <p class="text-xs">
                            <strong>Note:</strong> Internal reports show all cost details. Quotations hide profit margins and combine overhead into installation costs for client presentation.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="card">
                    <h2 class="card-header">
                        <span class="header-bar" style="background-color: #f97316;"></span>
                        Company Settings
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-input" id="companyName" value="RGS - Resa Gulf Scaffolding Co. Ltd.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Email</label>
                            <input type="email" class="form-input" id="companyEmail" value="info@rgsksa.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Phone</label>
                            <input type="text" class="form-input" id="companyPhone" value="+966 13 812 1111">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Labor Rate (SAR/hour)</label>
                            <input type="number" class="form-input" id="laborRate" value="35" onchange="calculateAll()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transport Rate (SAR)</label>
                            <input type="number" class="form-input" id="transportRate" value="500" onchange="calculateAll()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Equipment & Tools Rate (SAR)</label>
                            <input type="number" class="form-input" id="equipmentToolsRate" value="800" onchange="calculateAll()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overhead Percentage (%)</label>
                            <input type="number" class="form-input" id="overheadPercentage" value="10" onchange="calculateAll()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Profit Margin (%)</label>
                            <input type="number" class="form-input" id="profitMargin" value="15" onchange="calculateAll()">
                        </div>
                    </div>

                    <div class="info-box info-box-blue mt-4">
                        <h3 class="text-sm font-semibold mb-2" style="color: #1e40af;">📊 Cost Calculation Formula</h3>
                        <div class="text-xs" style="color: #1e40af;">
                            <p>1. <strong>Direct Costs</strong> = Material + Labor + Transport + Equipment</p>
                            <p>2. <strong>Overhead</strong> = Direct Costs × Overhead %</p>
                            <p>3. <strong>Subtotal</strong> = Direct Costs + Overhead</p>
                            <p>4. <strong>Profit</strong> = Subtotal × Profit %</p>
                            <p>5. <strong>Total Selling Price</strong> = Subtotal + Profit</p>
                        </div>
                    </div>

                    <button class="btn btn-secondary mt-4" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </main>
    </div>

    <style>
        .scaffolding-type-btn {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: left;
        }

        .scaffolding-type-btn:hover {
            border-color: #d1d5db;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .scaffolding-type-btn.active {
            border-color: #4b5563;
            background-color: #f3f4f6;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>

    <script>
        // Global state
        let state = {
            activeTab: 'calculator',
            scaffoldingType: 'birdcage',
            costOption: 'hire',
            progressPeriod: 'weekly',
            reportType: 'internal',
            reportSerialNumber: '',
            projectInfo: {
                clientName: '',
                projectName: '',
                location: '',
                date: new Date().toISOString().split('T')[0],
                productivityRate: 2.5,
                teamSize: 4,
                supervisorRatio: 10,
                projectDuration: 0,
                hireDuration: 30,
                marketAdjustment: 0
            },
            dimensions: {
                length: 0,
                width: 0,
                height: 0
            },
            settings: {
                laborRate: 35,
                transportRate: 500,
                equipmentToolsRate: 800,
                profitMargin: 15,
                overheadPercentage: 10
            },
            indirectPersonnel: {
                inspector: { enabled: true, rate: 45, quantity: 1 },
                supervisor: { enabled: true, rate: 50, quantity: 0 },
                hseOfficer: { enabled: true, rate: 40, quantity: 1 },
                permitReceiver: { enabled: true, rate: 35, quantity: 1 },
                projectLeader: { enabled: true, rate: 60, quantity: 1 }
            },
            boqItems: [],
            calculations: {}
        };

        // Debounce function to avoid excessive calculations
        let debounceTimer;
        function debounceCalculate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                calculateAll();
            }, 500);
        }

        // Material libraries
        const materialLibraries = {
            birdcage: [
                { id: 1, description: 'Ledgers', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.350000 },
                { id: 2, description: 'Ledgers - Transom', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.366667 },
                { id: 3, description: 'Standards', materialCode: 'RBPVE1GA', length: 2, unitWeight: 8.88, hireRate: 18.29, purchaseRate: 125.69, ratio: 0.385000 },
                { id: 4, description: 'Base Plate 0.5m', materialCode: 'COMHU1ZI', length: 0.5, unitWeight: 2.94, hireRate: 1.86, purchaseRate: 20.43, ratio: 0.085556 },
                { id: 5, description: 'Tube 1-1/2" Gal', materialCode: '1"1/2GL35', length: 3.5, unitWeight: 12.635, hireRate: 5.27, purchaseRate: 72.071, ratio: 0.040000 },
                { id: 6, description: 'Metal Planks (PL)', materialCode: 'RBPPL2GA', length: 2, unitWeight: 12.9, hireRate: 27.28, purchaseRate: 202.85, ratio: 3.456790 },
                { id: 7, description: 'Toe Board (Long)', materialCode: 'RBPRO12GA', length: 2, unitWeight: 8.36, hireRate: 14.26, purchaseRate: 97.47, ratio: 0.051852 },
                { id: 8, description: 'Toe Board (Trans)', materialCode: 'RBPRO12GA', length: 2, unitWeight: 8.36, hireRate: 14.26, purchaseRate: 97.47, ratio: 0.025926 },
                { id: 9, description: 'Ledger - Guard Rails (Long)', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.155556 },
                { id: 10, description: 'Ledger - Guard Rails (Trans)', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.077778 },
                { id: 11, description: 'Standard (Final-Top)', materialCode: 'RBPVE2GA', length: 1.5, unitWeight: 6.34, hireRate: 15.5, purchaseRate: 105.17, ratio: 0.022222 },
                { id: 12, description: 'Sole Board (LVL)', materialCode: 'LCLWOD4MTR', length: 4, unitWeight: 25.33, hireRate: 23.25, purchaseRate: 165.5, ratio: 0.021389 },
                { id: 13, description: 'Trap Door/Access', materialCode: 'COMPP3GA', length: 2, unitWeight: 31.85, hireRate: 79.67, purchaseRate: 589.1, ratio: 0.004444 },
                { id: 14, description: 'Access Stairs', materialCode: 'COMES1GA', length: 2, unitWeight: 10.14, hireRate: 26.35, purchaseRate: 202.64, ratio: 0.004444 },
                { id: 15, description: 'Swivel Clamp (Brace)', materialCode: 'GRAPAGI48', length: 'Each', unitWeight: 1.4, hireRate: 3.1, purchaseRate: 15.49, ratio: 0.112000 },
                { id: 16, description: 'Metal Planks (Access)', materialCode: 'RBPPL2GA', length: 2, unitWeight: 12.9, hireRate: 27.28, purchaseRate: 202.85, ratio: 0.098765 },
                { id: 17, description: 'Right Angle Coupler', materialCode: 'GRAPAOR48', length: 'Each', unitWeight: 1.06, hireRate: 1.24, purchaseRate: 17.23, ratio: 0.112000 }
            ],
            tower: [
                { id: 1, description: 'Ledgers', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.312500 },
                { id: 2, description: 'Transom', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.312500 },
                { id: 3, description: 'Standards', materialCode: 'RBPVE1GA', length: 2, unitWeight: 8.88, hireRate: 18.29, purchaseRate: 125.69, ratio: 0.625000 },
                { id: 4, description: 'Base Plate 0.5m', materialCode: 'COMHU1ZI', length: 'Each', unitWeight: 2.94, hireRate: 1.86, purchaseRate: 20.43, ratio: 0.125000 },
                { id: 5, description: 'Tube 1-1/2" Gal - Bracing', materialCode: 'RBPDI2GA', length: 2.9, unitWeight: 6.98, hireRate: 4.65, purchaseRate: 60.84, ratio: 0.500000 },
                { id: 6, description: 'Metal Planks (PL)', materialCode: 'RBPPL2GA', length: 2, unitWeight: 12.9, hireRate: 27.28, purchaseRate: 202.85, ratio: 0.833333 },
                { id: 7, description: 'Toe Board (Long)', materialCode: 'RBPRO12GA', length: 2, unitWeight: 8.36, hireRate: 14.26, purchaseRate: 97.47, ratio: 0.250000 },
                { id: 8, description: 'Toe Board (Trans)', materialCode: 'RBPRO12GA', length: 2, unitWeight: 8.36, hireRate: 14.26, purchaseRate: 97.47, ratio: 0.250000 },
                { id: 9, description: 'Tube 1-1/2" Gal - Guard Rails (Long)', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.125000 },
                { id: 10, description: 'Tube 1-1/2" Gal - Guard Rails-Pipe (Tran)', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.125000 },
                { id: 11, description: 'Standard (Final-Top)', materialCode: 'RBPVE2GA', length: 1.5, unitWeight: 6.34, hireRate: 15.5, purchaseRate: 105.17, ratio: 0.125000 },
                { id: 12, description: 'Sole Board (LVL)', materialCode: 'LCLWOD3.5MTR', length: 3.5, unitWeight: 15.83, hireRate: 23.25, purchaseRate: 165.5, ratio: 0.062500 },
                { id: 13, description: 'Trap Door/Access', materialCode: 'COMPP3GA', length: 2, unitWeight: 31.85, hireRate: 79.67, purchaseRate: 589.1, ratio: 0.125000 },
                { id: 14, description: 'Access Stairs', materialCode: 'COMES1GA', length: 2, unitWeight: 10.14, hireRate: 26.35, purchaseRate: 202.64, ratio: 0.500000 },
                { id: 15, description: 'Swivel Clamp (Brace)', materialCode: 'GRAPAGI48', length: 'Each', unitWeight: 1.4, hireRate: 3.1, purchaseRate: 15.49, ratio: 1.250000 },
                { id: 16, description: 'Metal Planks (Access)', materialCode: 'RBPPL2GA', length: 2, unitWeight: 12.9, hireRate: 27.28, purchaseRate: 202.85, ratio: 0.031250 },
                { id: 17, description: 'Right Angle Coupler', materialCode: 'GRAPAOR48', length: 'Each', unitWeight: 1.06, hireRate: 1.24, purchaseRate: 17.23, ratio: 1.250000 }
            ],
            independent: [
                { id: 1, description: 'Ledgers', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.471429 },
                { id: 2, description: 'Ledgers - Transom', materialCode: 'RBPLA3GA', length: 1.5, unitWeight: 6.16, hireRate: 8.99, purchaseRate: 61.56, ratio: 0.428571 },
                { id: 3, description: 'Standards', materialCode: 'RBPVE1GA', length: 2, unitWeight: 8.88, hireRate: 18.29, purchaseRate: 125.69, ratio: 0.430714 },
                { id: 4, description: 'Base Plate 0.5m', materialCode: 'COMHU1ZI', length: 'Each', unitWeight: 2.94, hireRate: 1.86, purchaseRate: 20.43, ratio: 0.095714 },
                { id: 5, description: 'Tube 1-1/2" Gal - Bracing', materialCode: 'RBPDI2GA', length: 2.9, unitWeight: 6.98, hireRate: 4.65, purchaseRate: 60.84, ratio: 0.031746 },
                { id: 6, description: 'Metal Planks (PL)', materialCode: 'RBPPL2GA', length: 2, unitWeight: 12.9, hireRate: 27.28, purchaseRate: 202.85, ratio: 0.819048 },
                { id: 7, description: 'Toe Board (Long)', materialCode: 'RBPRO12GA', length: 2, unitWeight: 8.36, hireRate: 14.26, purchaseRate: 97.47, ratio: 0.333333 },
                { id: 8, description: 'Toe Board (Trans)', materialCode: 'RBPRO13GA', length: 1.5, unitWeight: 6.38, hireRate: 14.26, purchaseRate: 97.47, ratio: 0.001667 },
                { id: 9, description: 'Ledger - Guard Rails (Long)', materialCode: 'RBPLA2GA', length: 2, unitWeight: 7.94, hireRate: 11.16, purchaseRate: 76.95, ratio: 0.666667 },
                { id: 10, description: 'Ledger - Guard Rails (Trans)', materialCode: 'RBPLA3GA', length: 1.5, unitWeight: 6.16, hireRate: 8.99, purchaseRate: 61.56, ratio: 0.001667 },
                { id: 11, description: 'Standard (Final-Top)', materialCode: 'RBPVE2GA', length: 1.5, unitWeight: 6.34, hireRate: 15.5, purchaseRate: 105.17, ratio: 0.095595 },
                { id: 12, description: 'Sole Board (LVL)', materialCode: 'LCLWOD2.5MTR', length: 3.5, unitWeight: 15.83, hireRate: 19.53, purchaseRate: 155.73, ratio: 0.047857 },
                { id: 13, description: 'Trap Door/Access', materialCode: 'COMPP3GA', length: 2, unitWeight: 31.85, hireRate: 79.67, purchaseRate: 589.1, ratio: 0.003175 },
                { id: 14, description: 'Access Stairs', materialCode: 'COMES1GA', length: 2, unitWeight: 10.14, hireRate: 26.35, purchaseRate: 202.64, ratio: 0.011111 },
                { id: 15, description: 'Swivel Clamp (Brace)', materialCode: 'GRAPAGI48', length: 'Each', unitWeight: 1.4, hireRate: 3.1, purchaseRate: 15.49, ratio: 0.079365 },
                { id: 16, description: 'Metal Planks (Access)', materialCode: 'RBPPL2GA', length: 2, unitWeight: 12.9, hireRate: 27.28, purchaseRate: 202.85, ratio: 0.000238 },
                { id: 17, description: 'Right Angle Coupler', materialCode: 'GRAPAOR48', length: 'Each', unitWeight: 1.06, hireRate: 1.24, purchaseRate: 17.23, ratio: 0.158730 }
            ],
            suspended: [
                { id: 1, description: 'Ladder Beam', materialCode: 'BL01', length: 6, unitWeight: 55.5, hireRate: 26.66, purchaseRate: 650, ratio: 0.156250 },
                { id: 2, description: 'Tube 1-1/2" Gal -Transom/Board Bearer', materialCode: '1"1/2GL15', length: 1.5, unitWeight: 5.415, hireRate: 2.48, purchaseRate: 41.18, ratio: 0.125000 },
                { id: 3, description: 'Tube 1-1/2" Gal - Hanger', materialCode: '1"1/2GL60', length: 6, unitWeight: 21.66, hireRate: 9.3, purchaseRate: 123.55, ratio: 0.234766 },
                { id: 4, description: 'Tube 1-1/2" Gal - Trapeze Tubes-Pipe', materialCode: '1"1/2GL05', length: 0.5, unitWeight: 1.805, hireRate: 0.93, purchaseRate: 12.316, ratio: 0.156510 },
                { id: 5, description: 'Tube 1-1/2" Gal - Longitudinal Bracing', materialCode: '1"1/2GL35', length: 3.5, unitWeight: 12.635, hireRate: 5.27, purchaseRate: 72.071, ratio: 0.125000 },
                { id: 6, description: 'Tube 1-1/2" Gal - Transverse Bracing', materialCode: '1"1/2GL35', length: 3.5, unitWeight: 12.635, hireRate: 5.27, purchaseRate: 72.071, ratio: 0.000179 },
                { id: 7, description: 'Toe Board -LVL (Long)', materialCode: 'LCLWOD4MTR', length: 4, unitWeight: 25.33, hireRate: 23.25, purchaseRate: 165.5, ratio: 0.093750 },
                { id: 8, description: 'Toe Board -LVL (Trans)', materialCode: '1"1/2GL30', length: 3, unitWeight: 19, hireRate: 18.6, purchaseRate: 145, ratio: 0.000208 },
                { id: 9, description: 'Tube 1-1/2" Gal - Guard Rails (Long)', materialCode: '1"1/2GL60', length: 6, unitWeight: 21.66, hireRate: 9.3, purchaseRate: 123.55, ratio: 0.002500 },
                { id: 10, description: 'Tube 1-1/2" Gal - Guard Rails-Pipe (Tran)', materialCode: '1"1/2GL30', length: 3, unitWeight: 5.415, hireRate: 4.65, purchaseRate: 60.84, ratio: 0.000208 },
                { id: 11, description: 'Wooden Plank (4.0m)', materialCode: 'LCLWOD3MTR', length: 4, unitWeight: 25.33, hireRate: 23.25, purchaseRate: 165.5, ratio: 1.250000 },
                { id: 12, description: 'Box Tie-Pipe', materialCode: '1"1/2GL05', length: 'Each', unitWeight: 1.805, hireRate: 1.55, purchaseRate: 17.23, ratio: 0.469531 },
                { id: 13, description: 'Tube 1-1/2" Gal - Plan Brace-Pipe', materialCode: '1"1/2GL35', length: 3.5, unitWeight: 12.635, hireRate: 5.27, purchaseRate: 72.071, ratio: 0.562500 },
                { id: 14, description: 'Swivel Clamp', materialCode: 'GRAPAGI48', length: 'Each', unitWeight: 1.4, hireRate: 3.1, purchaseRate: 15.49, ratio: 1.531868 },
                { id: 15, description: 'Double Clamp', materialCode: 'GRAPAOR48', length: 'Each', unitWeight: 1.06, hireRate: 2.17, purchaseRate: 17.23, ratio: 4.162760 },
                { id: 16, description: 'Girder Coupler', materialCode: 'GRAPAG48', length: 'Each', unitWeight: 1.6, hireRate: 5.58, purchaseRate: 51.1, ratio: 0.939063 },
                { id: 17, description: 'Tube 1-1/2" Gal -Transverse-Pipe', materialCode: '1"1/2GL60', length: 6, unitWeight: 21.66, hireRate: 9.3, purchaseRate: 123.55, ratio: 0.031250 },
                { id: 18, description: 'Sleeve Coupler', materialCode: 'SLCPLR48', length: 'Each', unitWeight: 1.25, hireRate: 1.24, purchaseRate: 15.49, ratio: 0.315000 },
                { id: 19, description: 'BRC Clamp', materialCode: 'BRCPLR48', length: 'Each', unitWeight: 1.06, hireRate: 1.55, purchaseRate: 17.23, ratio: 2.500000 }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set date to today
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // Generate initial serial number
            generateSerialNumber();
            
            // Initialize BOQ
            updateBoqItems();
            
            // Initial calculation - this will update all displays including base area visibility
            calculateAll();
            
            // Add event listeners for report section checkboxes
            const reportCheckboxes = [
                'report-project-info',
                'report-cost-breakdown',
                'report-workforce',
                'report-boq',
                'report-unit-rates',
                'report-mr-analysis'
            ];
            
            reportCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        if (state.activeTab === 'reports') {
                            updateReportPreview();
                        }
                    });
                }
            });
            
            // Add event listener for scope of work
            const scopeOfWorkTextarea = document.getElementById('scopeOfWork');
            if (scopeOfWorkTextarea) {
                scopeOfWorkTextarea.addEventListener('input', () => {
                    if (state.activeTab === 'reports') {
                        updateReportPreview();
                    }
                });
            }
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Update active state
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-button').classList.add('active');
            
            state.activeTab = tabName;
            
            // Update tab-specific content
            if (tabName === 'reports') {
                updateReportPreview();
            } else if (tabName === 'workforce') {
                updateCashFlowAnalysis();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // Scaffolding type selection
        function selectScaffoldingType(type) {
            state.scaffoldingType = type;
            
            // Update UI
            document.querySelectorAll('.scaffolding-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update labels and visibility based on type
            const lengthLabel = document.getElementById('length-label');
            const heightLabel = document.getElementById('height-label');
            const widthGroup = document.getElementById('width-group');
            const dimensionNote = document.getElementById('dimension-note');
            const productivityLabel = document.getElementById('productivityLabel');
            
            if (type === 'independent') {
                lengthLabel.textContent = 'Run Length (m)';
                widthGroup.style.display = 'none';
                dimensionNote.innerHTML = '<p class="text-xs text-yellow-600 bg-yellow-50 p-2 rounded mt-3"><strong>Note:</strong> Independent scaffolding width is fixed at 1.5m. Only enter the run length.</p>';
                dimensionNote.classList.remove('hidden');
                productivityLabel.textContent = `Productivity (m³/hr)`;
            } else if (type === 'suspended') {
                lengthLabel.textContent = 'Length (m)';
                heightLabel.textContent = 'Height (ref only)';
                widthGroup.style.display = 'block';
                dimensionNote.innerHTML = '<p class="text-xs text-blue-600 bg-blue-50 p-2 rounded mt-3"><strong>Note:</strong> Suspended scaffolding is measured by platform area (Length × Width) in m². Height is for reference only.</p>';
                dimensionNote.classList.remove('hidden');
                productivityLabel.textContent = `Productivity (m²/hr)`;
            } else {
                lengthLabel.textContent = 'Length (m)';
                heightLabel.textContent = 'Height (m)';
                widthGroup.style.display = 'block';
                dimensionNote.classList.add('hidden');
                productivityLabel.textContent = `Productivity (m³/hr)`;
            }
            
            // Update BOQ items
            updateBoqItems();
            
            // Recalculate
            calculateAll();
        }

        // Cost option selection
        function setCostOption(option) {
            state.costOption = option;
            
            // Update UI
            if (option === 'hire') {
                document.getElementById('hire-btn').classList.add('active');
                document.getElementById('purchase-btn').classList.remove('active');
                document.getElementById('hire-duration-badge').style.display = 'flex';
            } else {
                document.getElementById('purchase-btn').classList.add('active');
                document.getElementById('hire-btn').classList.remove('active');
                document.getElementById('hire-duration-badge').style.display = 'none';
            }
            
            // Update labels
            document.getElementById('cost-option-label').textContent = option;
            document.getElementById('cost-option-label2').textContent = option;
            
            // Recalculate
            calculateAll();
        }

        // Update BOQ items based on scaffolding type and dimensions
        function updateBoqItems() {
            const materials = materialLibraries[state.scaffoldingType];
            const measurementValue = getMeasurementValue();
            const marketMultiplier = 1 + (state.projectInfo.marketAdjustment / 100);
            
            state.boqItems = materials.map(material => {
                const quantity = measurementValue > 0 ? Math.ceil(measurementValue * material.ratio) : 0;
                const totalWeight = quantity * material.unitWeight;
                const baseDailyHireRate = material.hireRate / 30;
                
                // Check if we have a custom hire rate stored
                const existingItem = state.boqItems.find(item => item.id === material.id);
                const customDailyHireRate = existingItem ? existingItem.customDailyHireRate : null;
                const dailyHireRate = customDailyHireRate || baseDailyHireRate;
                
                // Market adjustment applies ONLY to hire rates, NOT purchase rates
                const adjustedDailyHireRate = dailyHireRate * marketMultiplier;
                const purchaseRate = material.purchaseRate; // No adjustment for purchase
                
                return {
                    ...material,
                    quantity,
                    totalWeight,
                    baseDailyHireRate,
                    dailyHireRate,
                    customDailyHireRate,
                    adjustedDailyHireRate,
                    purchaseRate, // Keep original purchase rate
                    hireAmount: quantity * adjustedDailyHireRate * state.projectInfo.hireDuration,
                    purchaseAmount: quantity * purchaseRate
                };
            });
            
            renderBoqTable();
        }

        // Update BOQ daily hire rate
        function updateBoqDailyRate(itemId, newRate) {
            const item = state.boqItems.find(i => i.id === itemId);
            if (item) {
                const newDailyRate = parseFloat(newRate) || 0;
                const marketMultiplier = 1 + (state.projectInfo.marketAdjustment / 100);
                
                item.customDailyHireRate = newDailyRate;
                item.dailyHireRate = newDailyRate;
                item.adjustedDailyHireRate = newDailyRate * marketMultiplier;
                item.hireAmount = item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration;
                
                renderBoqTable();
                calculateAll();
            }
        }

        // Render BOQ table
        function renderBoqTable() {
            const tbody = document.getElementById('boq-items');
            
            // Update scaffolding type in header
            document.getElementById('boq-scaffolding-type').textContent = 
                state.scaffoldingType.charAt(0).toUpperCase() + state.scaffoldingType.slice(1);
            
            // Update scaffolding type note
            const notes = {
                birdcage: '<strong>Birdcage Scaffolding:</strong> Full enclosed scaffold with materials calculated using standard ratios. Measurement: Volume (L × W × H) in m³. Hire rates are daily (monthly ÷ 30). <em>Note: Hire Rate Adjustment % affects hire rates only, not purchase prices.</em>',
                suspended: '<strong>Suspended Scaffolding:</strong> Hanging scaffold measured by platform area. Key items: Ladder Beams, Hangers, Wooden Planks, specialized clamps. Area-based (L × W) in m². <em>Note: Hire Rate Adjustment % affects hire rates only, not purchase prices.</em>',
                tower: '<strong>Tower Scaffolding:</strong> Vertical access scaffold for height work. Measurement: Volume (L × W × H) in m³. Optimized for vertical structures. <em>Note: Hire Rate Adjustment % affects hire rates only, not purchase prices.</em>',
                independent: '<strong>Independent Scaffolding:</strong> Perimeter scaffold with 1.5m fixed width. Measurement: Volume (Length × Height × 1.5m) in m³. Ideal for building facades. <em>Note: Hire Rate Adjustment % affects hire rates only, not purchase prices.</em>'
            };
            
            const noteElement = document.getElementById('scaffolding-type-note');
            noteElement.innerHTML = notes[state.scaffoldingType];
            noteElement.className = `info-box mb-3 ${
                state.scaffoldingType === 'birdcage' ? 'info-box-yellow' :
                state.scaffoldingType === 'suspended' ? 'info-box-blue' :
                state.scaffoldingType === 'tower' ? 'info-box-green' :
                'info-box-yellow'
            }`;
            
            tbody.innerHTML = state.boqItems.filter(item => item.quantity > 0).map((item, index) => {
                const amount = state.costOption === 'hire' 
                    ? item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration
                    : item.quantity * item.purchaseRate;
                
                const hasDiscount = item.customDailyHireRate && item.customDailyHireRate !== item.baseDailyHireRate;
                const discountPercent = hasDiscount ? 
                    ((1 - (item.customDailyHireRate / item.baseDailyHireRate)) * 100).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>${item.description}</td>
                        <td class="text-center" style="font-family: monospace;">${item.materialCode}</td>
                        <td class="text-center">
                            <input type="number" value="${item.quantity}" 
                                   onchange="updateBoqItemQuantity(${item.id}, this.value)"
                                   style="width: 4rem; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 0.25rem;">
                        </td>
                        <td class="text-center">${item.length}</td>
                        <td class="text-center">${item.unitWeight}</td>
                        <td class="text-center font-semibold">${item.totalWeight.toFixed(2)}</td>
                        <td class="text-center">
                            <div style="font-size: 0.875rem;">${item.purchaseRate.toFixed(2)}</div>
                            <div class="text-xs text-gray-500" style="margin-top: 0.25rem;">Daily: ${item.baseDailyHireRate.toFixed(3)}</div>
                        </td>
                        <td class="text-center">
                            <input type="number" step="0.001" value="${item.dailyHireRate.toFixed(3)}" 
                                   onchange="updateBoqDailyRate(${item.id}, this.value)"
                                   class="boq-hire-input">
                            ${hasDiscount ? `<span class="discount-badge">${discountPercent}%</span>` : ''}
                            ${state.projectInfo.marketAdjustment !== 0 ? 
                                `<div class="text-xs text-green-600" style="margin-top: 0.25rem;">${item.adjustedDailyHireRate.toFixed(3)}</div>` : ''}
                        </td>
                        <td class="text-center">
                            <input type="number" value="${state.projectInfo.hireDuration}" 
                                   disabled
                                   style="width: 4rem; padding: 0.25rem; text-align: center; background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 0.25rem;">
                        </td>
                        <td class="text-right font-semibold">${formatSAR(amount)}</td>
                        <td class="text-center">-</td>
                    </tr>
                `;
            }).join('');
            
            // Update totals
            const totalWeight = state.boqItems.reduce((sum, item) => sum + item.totalWeight, 0);
            const totalAmount = state.boqItems.reduce((sum, item) => {
                const amount = state.costOption === 'hire' 
                    ? item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration
                    : item.quantity * item.purchaseRate;
                return sum + amount;
            }, 0);
            
            document.getElementById('boq-total-weight').textContent = totalWeight.toFixed(0);
            document.getElementById('boq-total-amount').textContent = formatSAR(totalAmount);
            document.getElementById('total-weight-badge').textContent = (totalWeight / 1000).toFixed(2) + ' Tons';
            
            // Update purchase per ton (using non-adjusted purchase rates)
            const totalPurchaseCost = state.boqItems.reduce((sum, item) => {
                return sum + (item.quantity * item.purchaseRate);
            }, 0);
            const purchasePerTon = totalWeight > 0 ? (totalPurchaseCost / (totalWeight / 1000)) : 0;
            document.getElementById('purchase-per-ton-badge').textContent = formatSAR(purchasePerTon);
        }

        // Update BOQ item quantity
        function updateBoqItemQuantity(itemId, newQuantity) {
            const item = state.boqItems.find(i => i.id === itemId);
            if (item) {
                item.quantity = parseInt(newQuantity) || 0;
                item.totalWeight = item.quantity * item.unitWeight;
                renderBoqTable();
                calculateAll();
            }
        }

        // Add custom BOQ item
        function addBoqItem() {
            // This would open a dialog to add custom items
            alert('Custom BOQ items feature coming soon!');
        }

        // Get measurement value based on scaffolding type
        function getMeasurementValue() {
            const l = parseFloat(document.getElementById('length').value) || 0;
            const w = state.scaffoldingType !== 'independent' ? 
                     parseFloat(document.getElementById('width').value) || 0 : 1.5;
            const h = parseFloat(document.getElementById('height').value) || 0;
            
            switch (state.scaffoldingType) {
                case 'birdcage':
                case 'tower':
                    return l * w * h;
                case 'independent':
                    return l * h * 1.5;
                case 'suspended':
                    return l * w;
                default:
                    return 0;
            }
        }

        // Main calculation function
        function calculateAll() {
            // Get inputs
            const l = parseFloat(document.getElementById('length').value) || 0;
            const w = state.scaffoldingType !== 'independent' ? 
                     parseFloat(document.getElementById('width').value) || 0 : 1.5;
            const h = parseFloat(document.getElementById('height').value) || 0;
            
            state.dimensions = { length: l, width: w, height: h };
            
            // Get project info
            state.projectInfo.clientName = document.getElementById('clientName').value;
            state.projectInfo.projectName = document.getElementById('projectName').value;
            state.projectInfo.location = document.getElementById('location').value;
            state.projectInfo.date = document.getElementById('date').value;
            state.projectInfo.productivityRate = parseFloat(document.getElementById('productivityRate').value) || 2.5;
            state.projectInfo.teamSize = parseInt(document.getElementById('teamSize').value) || 4;
            state.projectInfo.projectDuration = parseInt(document.getElementById('projectDuration').value) || 0;
            state.projectInfo.hireDuration = parseInt(document.getElementById('hireDuration').value) || 30;
            state.projectInfo.marketAdjustment = parseFloat(document.getElementById('marketAdjustment').value) || 0;
            
            // Get settings
            state.settings.laborRate = parseFloat(document.getElementById('laborRate').value) || 35;
            state.settings.transportRate = parseFloat(document.getElementById('transportRate').value) || 500;
            state.settings.equipmentToolsRate = parseFloat(document.getElementById('equipmentToolsRate').value) || 800;
            state.settings.profitMargin = parseFloat(document.getElementById('profitMargin').value) || 15;
            state.settings.overheadPercentage = parseFloat(document.getElementById('overheadPercentage').value) || 10;
            
            // Get indirect personnel
            ['inspector', 'supervisor', 'hseOfficer', 'permitReceiver', 'projectLeader'].forEach(role => {
                state.indirectPersonnel[role].enabled = document.getElementById(`${role}-enabled`).checked;
                state.indirectPersonnel[role].rate = parseFloat(document.getElementById(`${role}-rate`).value) || 0;
                const qtyInput = document.getElementById(`${role}-qty`).value;
                state.indirectPersonnel[role].quantity = qtyInput ? parseInt(qtyInput) : 0;
            });
            
            // Calculate dimensions
            let volume = 0, area = 0, manhours = 0;
            let measurementUnit = 'm³', measurementValue = 0;
            
            switch (state.scaffoldingType) {
                case 'birdcage':
                    volume = l * w * h;
                    area = l * w;
                    measurementValue = volume;
                    measurementUnit = 'm³';
                    manhours = volume / state.projectInfo.productivityRate;
                    break;
                case 'tower':
                    area = l * w;
                    volume = area * h;
                    measurementValue = volume;
                    measurementUnit = 'm³';
                    manhours = volume / (state.projectInfo.productivityRate || 3.0);
                    break;
                case 'independent':
                    area = l * h;
                    volume = area * 1.5;
                    measurementValue = volume;
                    measurementUnit = 'm³';
                    manhours = volume / (state.projectInfo.productivityRate || 2.0);
                    break;
                case 'suspended':
                    area = l * w;
                    volume = area * 0.3;
                    measurementValue = area;
                    measurementUnit = 'm²';
                    manhours = area / (state.projectInfo.productivityRate || 4.0);
                    break;
            }
            
            // Update BOQ items
            updateBoqItems();
            
            // Calculate material cost
            let totalWeight = 0;
            const materialCost = state.boqItems.reduce((sum, item) => {
                totalWeight += item.totalWeight || 0;
                const amount = state.costOption === 'hire' 
                    ? item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration
                    : item.quantity * item.purchaseRate;
                return sum + amount;
            }, 0);
            
            // Workforce calculations
            const totalScaffolderHours = manhours;
            const totalScaffolderDays = totalScaffolderHours / 10; // 10 hours per day
            
            let actualProjectDays = state.projectInfo.projectDuration || 30;
            let scaffoldersRequired = Math.ceil(totalScaffolderDays / actualProjectDays);
            let teamsRequired = Math.ceil(scaffoldersRequired / state.projectInfo.teamSize);
            scaffoldersRequired = teamsRequired * state.projectInfo.teamSize;
            
            if (!state.projectInfo.projectDuration && totalScaffolderDays > 0) {
                actualProjectDays = Math.ceil(totalScaffolderDays / scaffoldersRequired);
            }
            
            // Ensure minimum 1 day to avoid division by zero
            actualProjectDays = Math.max(1, actualProjectDays);
            
            // Ensure minimum workforce
            scaffoldersRequired = Math.max(1, scaffoldersRequired || 1);
            teamsRequired = Math.max(1, teamsRequired || 1);
            
            const supervisorsRequired = Math.max(1, Math.ceil(scaffoldersRequired / 10));
            
            // Calculate labor costs
            const scaffolderLaborCost = totalScaffolderHours * state.settings.laborRate;
            
            let indirectPersonnelCost = 0;
            Object.entries(state.indirectPersonnel).forEach(([role, data]) => {
                if (data.enabled) {
                    const quantity = role === 'supervisor' && !data.quantity ? supervisorsRequired : data.quantity;
                    const hours = (quantity / scaffoldersRequired) * totalScaffolderHours;
                    indirectPersonnelCost += hours * data.rate;
                }
            });
            
            const totalLaborCost = scaffolderLaborCost + indirectPersonnelCost;
            
            // Calculate other costs
            const transportCost = state.settings.transportRate;
            const equipmentToolsCost = state.settings.equipmentToolsRate;
            
            // Calculate totals
            const directCosts = materialCost + totalLaborCost + transportCost + equipmentToolsCost;
            const overheadCost = directCosts * (state.settings.overheadPercentage / 100);
            const subtotal = directCosts + overheadCost;
            const profitAmount = subtotal * (state.settings.profitMargin / 100);
            const totalCost = subtotal + profitAmount;
            
            // Calculate unit rates
            const totalUnitRate = measurementValue > 0 ? totalCost / measurementValue : 0;
            const materialUnitRate = measurementValue > 0 ? materialCost / measurementValue : 0;
            const installationUnitRate = measurementValue > 0 ? (totalCost - materialCost) / measurementValue : 0;
            const dailyMaterialUnitRate = measurementValue > 0 && state.projectInfo.hireDuration > 0 ? 
                (materialCost / state.projectInfo.hireDuration) / measurementValue : 0;
            
            // Calculate MR% using adjusted hire rates but NON-adjusted purchase costs
            let totalProjectHireRevenue = 0;
            let totalPurchaseCost = 0;
            
            state.boqItems.forEach(item => {
                // Hire revenue uses adjusted rates (including discounts)
                totalProjectHireRevenue += item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration;
                // Purchase cost uses original rates (no adjustment)
                totalPurchaseCost += item.quantity * item.purchaseRate;
            });
            
            const mrPercentage = totalPurchaseCost > 0 ? 
                ((totalProjectHireRevenue / totalPurchaseCost) * 100).toFixed(2) : 0;
            
            // Calculate purchase per ton using non-adjusted rates
            const purchasePerTon = totalWeight > 0 ? (totalPurchaseCost / (totalWeight / 1000)) : 0;
            
            // Store calculations
            state.calculations = {
                volume,
                area,
                manhours,
                measurementValue,
                measurementUnit,
                materialCost,
                totalLaborCost,
                scaffolderLaborCost,
                indirectPersonnelCost,
                transportCost,
                equipmentToolsCost,
                directCosts,
                overheadCost,
                subtotal,
                profitAmount,
                totalCost,
                totalWeight,
                totalUnitRate,
                materialUnitRate,
                installationUnitRate,
                dailyMaterialUnitRate,
                scaffoldersRequired,
                teamsRequired,
                supervisorsRequired,
                actualProjectDays,
                mrPercentage,
                totalProjectHireRevenue,
                totalPurchaseCost,
                purchasePerTon
            };
            
            // Update UI
            updateCalculationResults();
            updateMRAnalysis();
            updateWorkforce();
            updateDashboard();
        }

        // Format currency
        function formatSAR(amount) {
            return `SAR ${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
        }

        // Update calculation results UI
        function updateCalculationResults() {
            const calc = state.calculations;
            
            // Update main results
            if (state.scaffoldingType === 'suspended') {
                // For suspended scaffolding, show area as primary measurement
                document.getElementById('volume-card').style.display = 'none';
                document.getElementById('base-area-card').style.display = 'block';
                document.getElementById('area-label').textContent = 'Platform Area';
                document.getElementById('result-area').textContent = `${calc.area.toFixed(2)} m²`;
            } else {
                // For other types, show volume and optionally base area
                document.getElementById('volume-card').style.display = 'block';
                document.getElementById('result-volume').textContent = `${calc.volume.toFixed(2)} m³`;
                document.getElementById('base-area-card').style.display = 'block';
                document.getElementById('area-label').textContent = 'Base Area';
                document.getElementById('result-area').textContent = `${calc.area.toFixed(2)} m²`;
            }
            
            document.getElementById('result-manhours').textContent = `${calc.manhours.toFixed(2)} hrs`;
            document.getElementById('result-totalcost').textContent = formatSAR(calc.totalCost);
            
            // Update unit rates
            document.getElementById('unit-rate-unit').textContent = calc.measurementUnit;
            document.getElementById('material-unit-rate').textContent = formatSAR(calc.materialUnitRate);
            document.getElementById('installation-unit-rate').textContent = formatSAR(calc.installationUnitRate);
            document.getElementById('total-unit-rate').textContent = formatSAR(calc.totalUnitRate);
            document.getElementById('daily-material-rate').textContent = `Daily: ${formatSAR(calc.dailyMaterialUnitRate)}`;
            
            // Update cost breakdown
            document.getElementById('material-cost').textContent = formatSAR(calc.materialCost);
            document.getElementById('mr-percentage').textContent = `${calc.mrPercentage}%`;
            document.getElementById('total-weight').textContent = `${(calc.totalWeight / 1000).toFixed(2)} Tons`;
            document.getElementById('total-weight-kg').textContent = `${calc.totalWeight.toFixed(0)} Kg`;
            document.getElementById('purchase-per-ton').textContent = formatSAR(calc.purchasePerTon);
            
            // Update hire duration displays
            document.getElementById('hire-duration-display').textContent = `${state.projectInfo.hireDuration} days`;
            document.getElementById('mr-hire-days').textContent = state.projectInfo.hireDuration;
            document.getElementById('mr-project-days').textContent = state.projectInfo.hireDuration;
            document.getElementById('hire-duration-badge-days').textContent = `${state.projectInfo.hireDuration} days`;
            
            // Update market adjustment display
            const marketAdjDisplay = document.getElementById('market-adjustment-display');
            const marketAdjBadge = document.getElementById('market-adjustment-badge-value');
            if (state.projectInfo.marketAdjustment !== 0) {
                const prefix = state.projectInfo.marketAdjustment > 0 ? '+' : '';
                marketAdjDisplay.innerHTML = ` • <span class="text-green-600">${prefix}${state.projectInfo.marketAdjustment}% adj.</span>`;
                marketAdjBadge.textContent = `${prefix}${state.projectInfo.marketAdjustment}%`;
            } else {
                marketAdjDisplay.innerHTML = '';
                marketAdjBadge.textContent = '0%';
            }
            
            // Update MR percentage color
            const mrElement = document.getElementById('mr-percentage');
            if (calc.mrPercentage >= 45) {
                mrElement.className = 'text-green-600';
            } else if (calc.mrPercentage >= 30) {
                mrElement.className = 'text-orange-600';
            } else {
                mrElement.className = 'text-red-600';
            }
        }

        // Update MR Analysis
        function updateMRAnalysis() {
            const calc = state.calculations;
            const mrPercentage = parseFloat(calc.mrPercentage) || 0;
            const projectsToBreakEven = mrPercentage > 0 ? Math.ceil(100 / mrPercentage) : 'N/A';
            const dailyRevenue = calc.totalProjectHireRevenue / state.projectInfo.hireDuration;
            
            // Update MR percentage displays
            document.getElementById('mr-percentage-large').textContent = `${mrPercentage}%`;
            document.getElementById('mr-projects-breakeven').textContent = projectsToBreakEven === 'N/A' ? 'N/A' : projectsToBreakEven;
            document.getElementById('mr-projects-needed').textContent = projectsToBreakEven === 'N/A' ? 'N/A projects' : `${projectsToBreakEven} projects`;
            
            // Update progress bar
            const progressBar = document.getElementById('mr-progress-bar');
            const progress = Math.min(mrPercentage, 100);
            progressBar.style.width = `${progress}%`;
            
            // Update financial details
            document.getElementById('mr-project-revenue').textContent = formatSAR(calc.totalProjectHireRevenue);
            document.getElementById('mr-daily-revenue').textContent = formatSAR(dailyRevenue);
            document.getElementById('mr-purchase-cost').textContent = formatSAR(calc.totalPurchaseCost);
            document.getElementById('mr-project-days2').textContent = state.projectInfo.hireDuration;
            
            // Update recovery status
            const recoveryStatus = document.getElementById('mr-recovery-status');
            if (mrPercentage >= 100) {
                recoveryStatus.textContent = 'Full Recovery in Single Project';
                recoveryStatus.style.color = '#059669';
            } else if (mrPercentage >= 50) {
                recoveryStatus.textContent = '2 Projects for Full Recovery';
                recoveryStatus.style.color = '#059669';
            } else if (mrPercentage >= 33.33) {
                recoveryStatus.textContent = '3 Projects for Full Recovery';
                recoveryStatus.style.color = '#ea580c';
            } else {
                recoveryStatus.textContent = 'Multiple Projects Needed';
                recoveryStatus.style.color = '#dc2626';
            }
            
            // Update analysis text
            const analysisText = document.getElementById('mr-analysis');
            if (mrPercentage >= 45) {
                analysisText.textContent = `Excellent return rate! This project recovers ${mrPercentage}% of purchase cost. You'll break even in just ${projectsToBreakEven} similar projects.`;
            } else if (mrPercentage >= 30) {
                analysisText.textContent = `Good return rate. This project recovers ${mrPercentage}% of purchase cost. Break-even requires ${projectsToBreakEven} similar projects.`;
            } else if (mrPercentage > 0) {
                analysisText.textContent = `Low return rate. Only ${mrPercentage}% of purchase cost recovered. Consider if ${projectsToBreakEven} similar projects are likely.`;
            } else {
                analysisText.textContent = 'No hire revenue calculated. Ensure all dimensions and hire duration are entered.';
            }
            
            // Update recommendation
            const recommendationText = document.getElementById('mr-recommendation');
            if (mrPercentage >= 45) {
                recommendationText.innerHTML = '<strong>Recommendation:</strong> Purchase is highly recommended. Excellent ROI potential with quick break-even.';
            } else if (mrPercentage >= 30) {
                recommendationText.innerHTML = '<strong>Recommendation:</strong> Purchase is recommended if you expect 3-4 similar projects within a year.';
            } else if (mrPercentage > 0) {
                recommendationText.innerHTML = '<strong>Recommendation:</strong> Hire may be more economical unless you have a pipeline of 5+ similar projects.';
            } else {
                recommendationText.innerHTML = '<strong>Recommendation:</strong> Enter project details to see purchase vs. hire recommendation.';
            }
            
            // Update explanation and decision guide
            const mrExplanation = document.getElementById('mr-explanation');
            const mrDecisionGuide = document.getElementById('mr-decision-guide');
            const mrBreakEven = document.getElementById('mr-break-even');
            
            if (mrPercentage > 0) {
                mrExplanation.textContent = ` For example, if you purchase materials for ${formatSAR(calc.totalPurchaseCost)}, this project's hire revenue would be ${formatSAR(calc.totalProjectHireRevenue)}, recovering ${mrPercentage}% of your investment.`;
                mrDecisionGuide.innerHTML = `<strong>Decision Guide:</strong> ${
                    mrPercentage >= 45 ? 'MR% ≥ 45% = Excellent (Purchase recommended)' :
                    mrPercentage >= 30 ? 'MR% 30-45% = Good (Purchase if regular projects)' :
                    'MR% < 30% = Low (Consider hire option)'
                }`;
                mrBreakEven.innerHTML = `<strong>Break-even Analysis:</strong> ${
                    projectsToBreakEven === 1 ? 'You recover your full investment in just this project!' :
                    projectsToBreakEven <= 3 ? `You need only ${projectsToBreakEven} similar projects to recover your full purchase investment.` :
                    `It will take ${projectsToBreakEven} similar projects to recover your purchase investment - consider if this volume is realistic.`
                }`;
            } else {
                mrExplanation.textContent = '';
                mrDecisionGuide.textContent = '';
                mrBreakEven.textContent = '';
            }
        }

        // Update workforce planning
        function updateWorkforce() {
            const calc = state.calculations;
            
            // Update workforce cards
            document.getElementById('workforce-scaffolders').textContent = calc.scaffoldersRequired;
            document.getElementById('workforce-team-size').textContent = state.projectInfo.teamSize;
            document.getElementById('workforce-teams').textContent = calc.teamsRequired;
            document.getElementById('workforce-days').textContent = calc.actualProjectDays;
            document.getElementById('workforce-project-days').textContent = calc.actualProjectDays;
            
            // Update phase durations
            const installationDays = calc.actualProjectDays;
            const hireDays = state.projectInfo.hireDuration;
            const dismantlingDays = Math.ceil(installationDays * 0.7);
            
            // Update phase duration displays if they exist
            const installationDaysEl = document.getElementById('installation-days');
            const hirePhaseDaysEl = document.getElementById('hire-phase-days');
            const dismantlingDaysEl = document.getElementById('dismantling-days');
            
            if (installationDaysEl) installationDaysEl.textContent = installationDays;
            if (hirePhaseDaysEl) hirePhaseDaysEl.textContent = hireDays;
            if (dismantlingDaysEl) dismantlingDaysEl.textContent = dismantlingDays;
            
            // Update workforce details
            const detailsDiv = document.getElementById('workforce-details');
            let indirectHtml = '';
            let totalIndirect = 0;
            
            Object.entries(state.indirectPersonnel).forEach(([role, data]) => {
                if (data.enabled) {
                    const quantity = role === 'supervisor' && !data.quantity ? calc.supervisorsRequired : data.quantity;
                    totalIndirect += quantity;
                    const hours = (quantity / calc.scaffoldersRequired) * calc.manhours;
                    const cost = hours * data.rate;
                    
                    indirectHtml += `
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span>${role.charAt(0).toUpperCase() + role.slice(1).replace(/([A-Z])/g, ' $1')}: ${quantity} × ${data.rate} SAR/hr</span>
                            <span>${formatSAR(cost)}</span>
                        </div>
                    `;
                }
            });
            
            detailsDiv.innerHTML = `
                <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <h4 style="font-weight: 600; margin-bottom: 10px;">Direct Labor</h4>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Scaffolders: ${calc.scaffoldersRequired} × ${state.settings.laborRate} SAR/hr × ${calc.manhours.toFixed(2)} hrs</span>
                        <span>${formatSAR(calc.scaffolderLaborCost)}</span>
                    </div>
                </div>
                
                ${indirectHtml ? `
                <div style="background: white; padding: 10px; border-radius: 5px;">
                    <h4 style="font-weight: 600; margin-bottom: 10px;">Indirect Personnel</h4>
                    ${indirectHtml}
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-weight: 600;">
                        <span>Total Indirect Cost</span>
                        <span>${formatSAR(calc.indirectPersonnelCost)}</span>
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 15px; padding: 10px; background: #374151; color: white; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; font-size: 1.1em; font-weight: bold;">
                        <span>Total Installation Cost</span>
                        <span>${formatSAR(calc.totalLaborCost)}</span>
                    </div>
                    <p style="font-size: 0.75rem; margin-top: 5px;">Total Workforce: ${calc.scaffoldersRequired + totalIndirect} people</p>
                </div>
                
                <div style="margin-top: 15px; background-color: #f9fafb; padding: 10px; border-radius: 5px;">
                    <h4 style="font-weight: 600; margin-bottom: 10px;">Project Timeline Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                        <div style="background: #fff7ed; padding: 8px; border-radius: 3px;">
                            <p class="text-xs font-semibold">Installation</p>
                            <p style="font-size: 1rem; font-weight: bold;">${installationDays} days</p>
                        </div>
                        <div style="background: #f0fdf4; padding: 8px; border-radius: 3px;">
                            <p class="text-xs font-semibold">Hire Period</p>
                            <p style="font-size: 1rem; font-weight: bold;">${hireDays} days</p>
                        </div>
                        <div style="background: #fee2e2; padding: 8px; border-radius: 3px;">
                            <p class="text-xs font-semibold">Dismantling</p>
                            <p style="font-size: 1rem; font-weight: bold;">${dismantlingDays} days</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 mt-2 text-center">
                        <strong>Total Project Duration:</strong> ${installationDays + hireDays + dismantlingDays} days
                    </p>
                </div>
            `;
            
            // Update supervisor quantity if auto
            const supervisorQtyInput = document.getElementById('supervisor-qty');
            if (!supervisorQtyInput.value) {
                supervisorQtyInput.placeholder = calc.supervisorsRequired;
            }
        }

        // Update dashboard
        function updateDashboard() {
            const calc = state.calculations;
            
            // Calculate phase durations
            const installationDays = calc.actualProjectDays;
            const hireDays = state.projectInfo.hireDuration;
            const dismantlingDays = Math.ceil(installationDays * 0.7);
            const totalProjectDays = installationDays + hireDays + dismantlingDays;
            
            // Update decision box
            const decisionBox = document.getElementById('dashboard-decision-box');
            const mrPercentage = parseFloat(calc.mrPercentage) || 0;
            
            let decisionColor, decisionTitle, decisionText;
            if (state.costOption === 'hire') {
                if (mrPercentage >= 45) {
                    decisionColor = '#fef3c7';
                    decisionTitle = 'Consider Purchase Option';
                    decisionText = `With ${mrPercentage}% MR, purchasing materials would provide excellent ROI. You'd recover your investment in just ${Math.ceil(100/mrPercentage)} similar projects. Current project generates revenue for only ${hireDays} days out of ${totalProjectDays} total days (${((hireDays/totalProjectDays)*100).toFixed(1)}%).`;
                } else if (mrPercentage >= 30) {
                    decisionColor = '#dbeafe';
                    decisionTitle = 'Hire is Reasonable';
                    decisionText = `Current hire option is reasonable. Purchase would require ${Math.ceil(100/mrPercentage)} similar projects to break even. Project has ${hireDays} revenue days vs ${installationDays + dismantlingDays} non-revenue days.`;
                } else {
                    decisionColor = '#d1fae5';
                    decisionTitle = 'Hire Recommended';
                    decisionText = `Hire is the optimal choice. Purchase would require ${Math.ceil(100/mrPercentage)} similar projects to break even, which may not be practical. Focus on maximizing hire period (currently ${hireDays} days) to improve profitability.`;
                }
            } else {
                if (mrPercentage >= 45) {
                    decisionColor = '#d1fae5';
                    decisionTitle = 'Excellent Purchase Decision';
                    decisionText = `Purchase provides ${mrPercentage}% return per project. You'll break even in just ${Math.ceil(100/mrPercentage)} projects. Smart investment with ${hireDays} revenue-generating days.`;
                } else if (mrPercentage >= 30) {
                    decisionColor = '#dbeafe';
                    decisionTitle = 'Good Purchase Decision';
                    decisionText = `Purchase is reasonable with ${mrPercentage}% return. Break-even after ${Math.ceil(100/mrPercentage)} similar projects. Consider extending hire periods to improve ROI.`;
                } else {
                    decisionColor = '#fee2e2';
                    decisionTitle = 'Review Purchase Decision';
                    decisionText = `Low ${mrPercentage}% return means ${Math.ceil(100/mrPercentage)} projects needed to break even. With only ${hireDays} revenue days out of ${totalProjectDays} total, hire might be more economical.`;
                }
            }
            
            decisionBox.style.backgroundColor = decisionColor;
            decisionBox.innerHTML = `
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;">${decisionTitle}</h3>
                <p>${decisionText}</p>
                <div style="margin-top: 10px; display: flex; gap: 15px; font-size: 0.875rem;">
                    <span><strong>Installation:</strong> ${installationDays} days</span>
                    <span style="color: #059669;"><strong>Revenue Period:</strong> ${hireDays} days</span>
                    <span><strong>Dismantling:</strong> ${dismantlingDays} days</span>
                </div>
            `;
            
            // Update dashboard cards
            document.getElementById('dashboard-unit-rate').textContent = formatSAR(calc.totalUnitRate);
            document.getElementById('dashboard-unit').textContent = calc.measurementUnit;
            document.getElementById('dashboard-profit').textContent = formatSAR(calc.profitAmount);
            document.getElementById('dashboard-profit-margin').textContent = state.settings.profitMargin;
            document.getElementById('dashboard-days').textContent = `${totalProjectDays} days`;
            document.getElementById('dashboard-workforce').textContent = calc.scaffoldersRequired + Object.values(state.indirectPersonnel).reduce((sum, role) => {
                return sum + (role.enabled ? (role.quantity || (role === 'supervisor' ? calc.supervisorsRequired : 0)) : 0);
            }, 0);
            
            // Update MR% card
            const mrCard = document.getElementById('dashboard-mr-card');
            const mrColor = mrPercentage >= 45 ? '#10b981' : mrPercentage >= 30 ? '#f97316' : '#ef4444';
            mrCard.style.setProperty('--from-color', mrPercentage >= 45 ? '#d1fae5' : mrPercentage >= 30 ? '#fed7aa' : '#fee2e2');
            mrCard.style.setProperty('--to-color', mrPercentage >= 45 ? '#6ee7b7' : mrPercentage >= 30 ? '#fb923c' : '#fca5a5');
            mrCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span>💰</span>
                    <span class="text-xs font-medium" style="color: ${mrColor}; background-color: rgba(0,0,0,0.05); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">MR%</span>
                </div>
                <p style="font-size: 1.25rem; font-weight: bold; color: #1f2937;">${mrPercentage}%</p>
                <p class="text-xs text-gray-600 mt-1">${Math.ceil(100/mrPercentage) || 'N/A'} projects to break-even</p>
            `;
            
            // Update cost breakdown with phase information
            const costBreakdown = document.getElementById('cost-breakdown');
            
            // Calculate phase-specific costs
            const installationCost = calc.scaffolderLaborCost + calc.indirectPersonnelCost + 
                                    calc.transportCost + calc.equipmentToolsCost + 
                                    (state.costOption === 'purchase' ? calc.materialCost : 0);
            const supervisionCost = (50 + 45) * 10 * hireDays; // Supervisor + Inspector
            const dismantlingCost = (calc.scaffolderLaborCost + calc.indirectPersonnelCost) * 0.7;
            
            costBreakdown.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 8px; color: #4b5563;">Phase Costs Breakdown</h4>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Installation Phase:</span>
                        <span>${formatSAR(installationCost)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Hire Period Supervision:</span>
                        <span>${formatSAR(supervisionCost)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Dismantling Phase:</span>
                        <span>${formatSAR(dismantlingCost)}</span>
                    </div>
                    ${state.costOption === 'hire' ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Material Hire (${hireDays} days):</span>
                        <span>${formatSAR(calc.materialCost)}</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; margin: 5px 0; padding-top: 5px; border-top: 1px solid #e5e7eb;">
                        <span>Direct Costs:</span>
                        <span>${formatSAR(calc.directCosts)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Overhead (${state.settings.overheadPercentage}%):</span>
                        <span>${formatSAR(calc.overheadCost)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Profit (${state.settings.profitMargin}%):</span>
                        <span>${formatSAR(calc.profitAmount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0; padding-top: 5px; border-top: 2px solid #374151; font-weight: bold;">
                        <span>Total:</span>
                        <span>${formatSAR(calc.totalCost)}</span>
                    </div>
                </div>
            `;
            
            // Update unit rate analysis
            const unitRateAnalysis = document.getElementById('unit-rate-analysis');
            const materialPercent = calc.totalCost > 0 ? ((calc.materialCost / calc.totalCost) * 100).toFixed(1) : 0;
            const laborPercent = calc.totalCost > 0 ? ((calc.totalLaborCost / calc.totalCost) * 100).toFixed(1) : 0;
            const otherPercent = calc.totalCost > 0 ? (((calc.transportCost + calc.equipmentToolsCost) / calc.totalCost) * 100).toFixed(1) : 0;
            const overheadProfitPercent = calc.totalCost > 0 ? (((calc.overheadCost + calc.profitAmount) / calc.totalCost) * 100).toFixed(1) : 0;
            
            unitRateAnalysis.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <p style="font-weight: 600; margin-bottom: 5px;">Cost per ${calc.measurementUnit}:</p>
                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                        <span>Material:</span>
                        <span>${formatSAR(calc.materialUnitRate)} (${materialPercent}%)</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                        <span>Installation:</span>
                        <span>${formatSAR(calc.installationUnitRate)} (${(100 - materialPercent).toFixed(1)}%)</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 3px 0; padding-top: 5px; border-top: 1px solid #e5e7eb; font-weight: bold;">
                        <span>Total:</span>
                        <span>${formatSAR(calc.totalUnitRate)}</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <p style="font-weight: 600; margin-bottom: 5px;">Project Efficiency Metrics:</p>
                    <div style="background-color: #f9fafb; padding: 8px; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                            <span class="text-xs">Revenue Days:</span>
                            <span class="text-xs font-semibold text-green-600">${hireDays} days (${((hireDays/totalProjectDays)*100).toFixed(1)}%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                            <span class="text-xs">Non-Revenue Days:</span>
                            <span class="text-xs font-semibold text-red-600">${installationDays + dismantlingDays} days (${(((installationDays + dismantlingDays)/totalProjectDays)*100).toFixed(1)}%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                            <span class="text-xs">Installation Efficiency:</span>
                            <span class="text-xs font-semibold">${(calc.measurementValue / installationDays).toFixed(2)} ${calc.measurementUnit}/day</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <p style="font-weight: 600; margin-bottom: 5px;">Cost Distribution:</p>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <div style="background-color: #3b82f6; height: 20px; width: ${materialPercent}%; border-radius: 3px;" title="Material: ${materialPercent}%"></div>
                        <div style="background-color: #10b981; height: 20px; width: ${laborPercent}%; border-radius: 3px;" title="Labor: ${laborPercent}%"></div>
                        <div style="background-color: #f59e0b; height: 20px; width: ${otherPercent}%; border-radius: 3px;" title="Transport & Equipment: ${otherPercent}%"></div>
                        <div style="background-color: #8b5cf6; height: 20px; width: ${overheadProfitPercent}%; border-radius: 3px;" title="Overhead & Profit: ${overheadProfitPercent}%"></div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 5px; font-size: 0.75rem;">
                        <span><span style="background-color: #3b82f6; width: 10px; height: 10px; display: inline-block; border-radius: 2px;"></span> Material</span>
                        <span><span style="background-color: #10b981; width: 10px; height: 10px; display: inline-block; border-radius: 2px;"></span> Labor</span>
                        <span><span style="background-color: #f59e0b; width: 10px; height: 10px; display: inline-block; border-radius: 2px;"></span> Other</span>
                        <span><span style="background-color: #8b5cf6; width: 10px; height: 10px; display: inline-block; border-radius: 2px;"></span> OH&P</span>
                    </div>
                </div>
            `;
        }

        // Update report preview
        function updateReportPreview() {
            const previewDiv = document.getElementById('report-preview');
            const calc = state.calculations;
            const isQuotation = state.reportType === 'quotation';
            
            // Get selected sections
            const includeProjectInfo = document.getElementById('report-project-info').checked;
            const includeCostBreakdown = document.getElementById('report-cost-breakdown').checked;
            const includeWorkforce = document.getElementById('report-workforce').checked;
            const includeBoq = document.getElementById('report-boq').checked;
            const includeUnitRates = document.getElementById('report-unit-rates').checked;
            const includeMrAnalysis = !isQuotation && document.getElementById('report-mr-analysis').checked;
            
            // Get scope of work
            const scopeOfWork = document.getElementById('scopeOfWork').value;
            
            let previewHtml = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="font-size: 1.25rem; font-weight: bold;">RGS - ${isQuotation ? 'Quotation' : 'Estimation Report'}</h3>
                    <p style="font-size: 0.875rem; color: #6b7280;">Serial No: ${state.reportSerialNumber}</p>
                </div>
            `;
            
            if (scopeOfWork) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Scope of Work</h4>
                        <pre style="font-size: 0.875rem; white-space: pre-wrap; font-family: inherit;">${scopeOfWork}</pre>
                    </div>
                `;
            }
            
            if (includeProjectInfo) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Project Information</h4>
                        <p style="font-size: 0.875rem;">Client: ${state.projectInfo.clientName || 'N/A'}</p>
                        <p style="font-size: 0.875rem;">Project: ${state.projectInfo.projectName || 'N/A'}</p>
                        <p style="font-size: 0.875rem;">Type: ${state.scaffoldingType} scaffolding</p>
                        <p style="font-size: 0.875rem;">${calc.measurementUnit === 'm²' ? 'Platform Area' : 'Volume'}: ${calc.measurementValue.toFixed(2)} ${calc.measurementUnit}</p>
                    </div>
                `;
            }
            
            if (includeCostBreakdown) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Cost Summary</h4>
                        <p style="font-size: 0.875rem;">Material (${state.costOption}): ${formatSAR(calc.materialCost)}</p>
                        <p style="font-size: 0.875rem;">Installation: ${formatSAR(isQuotation ? calc.totalLaborCost + calc.overheadCost : calc.totalLaborCost)}</p>
                        ${!isQuotation ? `<p style="font-size: 0.875rem;">Overhead: ${formatSAR(calc.overheadCost)}</p>` : ''}
                        ${!isQuotation ? `<p style="font-size: 0.875rem;">Profit: ${formatSAR(calc.profitAmount)}</p>` : ''}
                        <p style="font-size: 0.875rem; font-weight: bold;">Total: ${formatSAR(calc.totalCost)}</p>
                    </div>
                `;
            }
            
            if (includeWorkforce) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Workforce Planning</h4>
                        <p style="font-size: 0.875rem;">Scaffolders: ${calc.scaffoldersRequired} (${calc.teamsRequired} teams)</p>
                        <p style="font-size: 0.875rem;">Duration: ${calc.actualProjectDays} days</p>
                    </div>
                `;
            }
            
            if (includeBoq) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Bill of Quantities</h4>
                        <p style="font-size: 0.875rem;">${state.boqItems.filter(i => i.quantity > 0).length} items</p>
                        <p style="font-size: 0.875rem;">Total Weight: ${(calc.totalWeight / 1000).toFixed(2)} tons</p>
                    </div>
                `;
            }
            
            if (includeUnitRates) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Unit Rates</h4>
                        <p style="font-size: 0.875rem;">Total Unit Rate: ${formatSAR(calc.totalUnitRate)}/${calc.measurementUnit}</p>
                    </div>
                `;
            }
            
            if (includeMrAnalysis) {
                previewHtml += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; margin-bottom: 5px;">Material Return Analysis</h4>
                        <p style="font-size: 0.875rem;">MR%: ${calc.mrPercentage}%</p>
                        <p style="font-size: 0.875rem;">Break-even: ${Math.ceil(100/calc.mrPercentage) || 'N/A'} projects</p>
                    </div>
                `;
            }
            
            previewDiv.innerHTML = previewHtml;
        }

        // Cash flow and progress analysis
        function setProgressPeriod(period) {
            state.progressPeriod = period;
            
            // Update UI
            document.getElementById('weekly-btn').classList.toggle('active', period === 'weekly');
            document.getElementById('monthly-btn').classList.toggle('active', period === 'monthly');
            
            updateCashFlowAnalysis();
        }

        function updateCashFlowAnalysis() {
            const calc = state.calculations;
            const period = state.progressPeriod;
            
            // Calculate phase durations
            const installationDays = calc.actualProjectDays;
            const hireDays = state.projectInfo.hireDuration;
            const dismantlingDays = Math.ceil(installationDays * 0.7); // Dismantling is typically 70% of installation time
            const totalProjectDays = installationDays + hireDays + dismantlingDays;
            
            // Calculate daily values for each phase
            const dailyInstallationProgress = calc.measurementValue / installationDays;
            const dailyDismantlingProgress = calc.measurementValue / dismantlingDays;
            
            // Calculate costs
            const installationLaborCost = calc.scaffolderLaborCost;
            const installationIndirectCost = calc.indirectPersonnelCost;
            const dismantlingLaborCost = installationLaborCost * 0.7; // Dismantling typically costs 70% of installation
            const dismantlingIndirectCost = installationIndirectCost * 0.7;
            
            // During hire phase, only supervision costs (reduced workforce)
            const supervisionDailyRate = 50; // Supervisor rate
            const inspectorDailyRate = 45; // Inspector rate
            const dailySupervisionCost = (supervisionDailyRate + inspectorDailyRate) * 10; // 10 hours/day
            const totalSupervisionCost = dailySupervisionCost * hireDays;
            
            // Material costs are incurred during installation only (if purchase option)
            const materialCostDuringInstallation = state.costOption === 'purchase' ? calc.materialCost : 0;
            
            // Hire revenue only during hire phase
            const dailyHireRevenue = state.costOption === 'hire' ? calc.materialCost / hireDays : 0;
            const totalHireRevenue = dailyHireRevenue * hireDays;
            
            // Installation service revenue (received as progress payments)
            const installationServiceRevenue = calc.totalLaborCost + calc.transportCost + calc.equipmentToolsCost + 
                                             calc.overheadCost + calc.profitAmount;
            
            // Update summary cards
            document.getElementById('daily-progress').textContent = `${dailyInstallationProgress.toFixed(2)} ${calc.measurementUnit}/day`;
            document.getElementById('weekly-progress').textContent = `${(dailyInstallationProgress * 6).toFixed(2)} ${calc.measurementUnit}/week`;
            document.getElementById('daily-cost').textContent = formatSAR(installationLaborCost / installationDays);
            document.getElementById('daily-revenue').textContent = formatSAR(dailyHireRevenue);
            
            // Update progress units in table headers
            document.getElementById('progress-unit').textContent = calc.measurementUnit;
            document.getElementById('progress-unit2').textContent = calc.measurementUnit;
            
            // Generate cash flow table
            const tbody = document.getElementById('cash-flow-table');
            const rows = [];
            
            let currentDay = 0;
            let cumulativeProgress = 0;
            let cumulativeCF = 0;
            
            // Helper function to add phase rows
            const addPhaseRows = (phase, phaseDays, phaseProgress, phaseMaterialCost, phaseLaborCost, phaseOtherCost, phaseRevenue) => {
                const periodDays = period === 'weekly' ? 6 : 26;
                const periods = Math.ceil(phaseDays / periodDays);
                
                for (let p = 1; p <= periods; p++) {
                    const daysInPeriod = p === periods ? phaseDays - (p - 1) * periodDays : periodDays;
                    const periodProgress = phaseProgress * daysInPeriod;
                    cumulativeProgress += phase === 'Dismantling' ? -periodProgress : periodProgress;
                    
                    const progressPercent = phase === 'Hire' ? 100 : 
                                          phase === 'Dismantling' ? (100 - (cumulativeProgress / calc.measurementValue) * 100) :
                                          (cumulativeProgress / calc.measurementValue) * 100;
                    
                    const periodMaterialCost = (phaseMaterialCost / phaseDays) * daysInPeriod;
                    const periodLaborCost = (phaseLaborCost / phaseDays) * daysInPeriod;
                    const periodOtherCost = (phaseOtherCost / phaseDays) * daysInPeriod;
                    const periodTotalCost = periodMaterialCost + periodLaborCost + periodOtherCost;
                    const periodRevenue = (phaseRevenue / phaseDays) * daysInPeriod;
                    const periodCashFlow = periodRevenue - periodTotalCost;
                    cumulativeCF += periodCashFlow;
                    
                    currentDay += daysInPeriod;
                    
                    rows.push({
                        period: `${phase} ${period === 'weekly' ? 'W' : 'M'}${p}`,
                        days: daysInPeriod,
                        progress: phase === 'Hire' ? 0 : periodProgress,
                        cumulative: phase === 'Hire' ? calc.measurementValue : Math.abs(cumulativeProgress),
                        progressPercent: Math.abs(progressPercent),
                        materialCost: periodMaterialCost,
                        laborCost: periodLaborCost,
                        otherCost: periodOtherCost,
                        totalCost: periodTotalCost,
                        revenue: periodRevenue,
                        cashFlow: periodCashFlow,
                        cumulativeCF,
                        phase
                    });
                }
            };
            
            // Phase 1: Installation (High cost, installation revenue only)
            const installationRevenue = installationServiceRevenue * 0.7; // 70% paid during installation
            const installationOtherCost = calc.transportCost + calc.equipmentToolsCost;
            addPhaseRows('Installation', installationDays, dailyInstallationProgress, 
                        materialCostDuringInstallation, installationLaborCost + installationIndirectCost, 
                        installationOtherCost, installationRevenue);
            
            // Phase 2: Hire Period (Low cost, hire revenue + remaining installation payment)
            const hirePhaseInstallationRevenue = installationServiceRevenue * 0.3; // 30% paid after handover
            const hirePhaseRevenue = totalHireRevenue + hirePhaseInstallationRevenue;
            addPhaseRows('Hire', hireDays, 0, 0, totalSupervisionCost, 0, hirePhaseRevenue);
            
            // Phase 3: Dismantling (High cost, no revenue)
            addPhaseRows('Dismantling', dismantlingDays, dailyDismantlingProgress, 
                        0, dismantlingLaborCost + dismantlingIndirectCost, 0, 0);
            
            // Render table rows with phase coloring
            tbody.innerHTML = rows.map(row => `
                <tr style="background-color: ${
                    row.phase === 'Installation' ? '#fff7ed' :
                    row.phase === 'Hire' ? '#f0fdf4' :
                    '#fee2e2'
                };">
                    <td class="text-center">${row.period}</td>
                    <td class="text-center">${row.days}</td>
                    <td class="text-center">${row.progress.toFixed(2)}</td>
                    <td class="text-center">${row.cumulative.toFixed(2)}</td>
                    <td class="text-center">${row.progressPercent.toFixed(1)}%</td>
                    <td class="text-right">${formatSAR(row.materialCost)}</td>
                    <td class="text-right">${formatSAR(row.laborCost)}</td>
                    <td class="text-right">${formatSAR(row.otherCost)}</td>
                    <td class="text-right">${formatSAR(row.totalCost)}</td>
                    <td class="text-right">${formatSAR(row.revenue)}</td>
                    <td class="text-right" style="color: ${row.cashFlow >= 0 ? '#059669' : '#dc2626'}; font-weight: bold;">${formatSAR(row.cashFlow)}</td>
                    <td class="text-right" style="font-weight: 600; color: ${row.cumulativeCF >= 0 ? '#059669' : '#dc2626'};">${formatSAR(row.cumulativeCF)}</td>
                </tr>
            `).join('');
            
            // Calculate totals
            const totalMaterialCost = materialCostDuringInstallation;
            const totalLaborCost = installationLaborCost + installationIndirectCost + totalSupervisionCost + 
                                 dismantlingLaborCost + dismantlingIndirectCost;
            const totalOtherCost = installationOtherCost;
            const totalCosts = totalMaterialCost + totalLaborCost + totalOtherCost;
            const totalRevenue = installationServiceRevenue + totalHireRevenue;
            const totalCashFlow = totalRevenue - totalCosts;
            
            // Update totals
            document.getElementById('cf-total-progress').textContent = '100%';
            document.getElementById('cf-total-material').textContent = formatSAR(totalMaterialCost);
            document.getElementById('cf-total-labor').textContent = formatSAR(totalLaborCost);
            document.getElementById('cf-total-other').textContent = formatSAR(totalOtherCost);
            document.getElementById('cf-total-cost').textContent = formatSAR(totalCosts);
            document.getElementById('cf-total-revenue').textContent = formatSAR(totalRevenue);
            document.getElementById('cf-total-cashflow').textContent = formatSAR(totalCashFlow);
            document.getElementById('cf-final-cumulative').textContent = formatSAR(totalCashFlow);
            
            // Create phase-based chart
            const chartDiv = document.getElementById('cash-flow-chart');
            const maxValue = Math.max(...rows.map(r => Math.max(r.revenue, r.totalCost)));
            
            // Group rows by phase for better visualization
            const phases = {
                Installation: rows.filter(r => r.phase === 'Installation'),
                Hire: rows.filter(r => r.phase === 'Hire'),
                Dismantling: rows.filter(r => r.phase === 'Dismantling')
            };
            
            chartDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
                        <div style="text-align: center; padding: 10px; background-color: #fff7ed; border-radius: 5px;">
                            <strong>Installation Phase</strong>
                            <p style="font-size: 0.75rem; margin-top: 5px;">${installationDays} days</p>
                            <p style="font-size: 0.875rem; color: #dc2626;">High Cost / Limited Revenue</p>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: #f0fdf4; border-radius: 5px;">
                            <strong>Hire Phase</strong>
                            <p style="font-size: 0.75rem; margin-top: 5px;">${hireDays} days</p>
                            <p style="font-size: 0.875rem; color: #059669;">Low Cost / Full Revenue</p>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: #fee2e2; border-radius: 5px;">
                            <strong>Dismantling Phase</strong>
                            <p style="font-size: 0.75rem; margin-top: 5px;">${dismantlingDays} days</p>
                            <p style="font-size: 0.875rem; color: #dc2626;">High Cost / No Revenue</p>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 250px; padding: 10px;">
                    ${rows.map(row => `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; margin: 0 2px;">
                            <div style="display: flex; align-items: flex-end; height: 200px; gap: 2px;">
                                <div style="width: 15px; background-color: #3b82f6; height: ${(row.revenue / maxValue) * 180}px;" 
                                     title="Revenue: ${formatSAR(row.revenue)}"></div>
                                <div style="width: 15px; background-color: #ef4444; height: ${(row.totalCost / maxValue) * 180}px;" 
                                     title="Cost: ${formatSAR(row.totalCost)}"></div>
                            </div>
                            <p style="font-size: 0.625rem; margin-top: 5px; writing-mode: vertical-rl; text-orientation: mixed;">${row.period}</p>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
                    <span style="font-size: 0.75rem;"><span style="background-color: #3b82f6; width: 12px; height: 12px; display: inline-block;"></span> Revenue</span>
                    <span style="font-size: 0.75rem;"><span style="background-color: #ef4444; width: 12px; height: 12px; display: inline-block;"></span> Cost</span>
                </div>
            `;
            
            // Update insights with phase-specific information
            const revenueInsights = document.getElementById('revenue-insights');
            const costAlerts = document.getElementById('cost-control-alerts');
            
            const profitMarginActual = (totalCashFlow / totalRevenue) * 100;
            const breakEvenDay = rows.findIndex(r => r.cumulativeCF > 0) + 1;
            const breakEvenPhase = breakEvenDay > 0 ? rows[breakEvenDay - 1].phase : 'Never';
            
            revenueInsights.innerHTML = `
                <p>• Project Net Margin: ${profitMarginActual.toFixed(1)}%</p>
                <p>• Break-even: ${breakEvenPhase === 'Never' ? 'No break-even' : `During ${breakEvenPhase} phase`}</p>
                <p>• Installation Revenue: ${formatSAR(installationServiceRevenue)}</p>
                <p>• Hire Revenue: ${formatSAR(totalHireRevenue)} (${hireDays} days)</p>
                <p>• Daily Hire Rate: ${formatSAR(dailyHireRevenue)}</p>
            `;
            
            const installationCostPercent = ((installationLaborCost + installationIndirectCost) / totalCosts) * 100;
            const supervisionCostPercent = (totalSupervisionCost / totalCosts) * 100;
            const dismantlingCostPercent = ((dismantlingLaborCost + dismantlingIndirectCost) / totalCosts) * 100;
            
            costAlerts.innerHTML = `
                <p>• Installation costs: ${installationCostPercent.toFixed(1)}% of total</p>
                <p>• Supervision during hire: ${supervisionCostPercent.toFixed(1)}% of total</p>
                <p>• Dismantling costs: ${dismantlingCostPercent.toFixed(1)}% of total</p>
                ${installationDays > 30 ? '<p style="color: #ea580c;">⚠ Long installation period affects cash flow</p>' : ''}
                ${hireDays < 30 ? '<p style="color: #dc2626;">⚠ Short hire period limits revenue potential</p>' : ''}
                <p style="color: #059669;">✓ ${((hireDays / totalProjectDays) * 100).toFixed(1)}% of project generates revenue</p>
            `;
        }

        // Generate serial number
        function generateSerialNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            state.reportSerialNumber = `RGS-${year}${month}${day}-${random}`;
            document.getElementById('reportSerialNumber').value = state.reportSerialNumber;
        }

        // Update report type settings
        function updateReportTypeSettings() {
            const reportType = document.getElementById('reportType').value;
            state.reportType = reportType;
            
            // Update MR analysis visibility based on report type
            const mrOption = document.getElementById('mr-analysis-option');
            if (reportType === 'quotation') {
                // Hide MR analysis for quotations
                mrOption.style.display = 'none';
                document.getElementById('report-mr-analysis').checked = false;
            } else {
                mrOption.style.display = 'block';
            }
            
            updateReportPreview();
        }

        // Report helper functions
        function selectAllReportSections() {
            const checkboxes = ['report-project-info', 'report-cost-breakdown', 'report-workforce', 
                               'report-boq', 'report-unit-rates'];
            if (state.reportType !== 'quotation') {
                checkboxes.push('report-mr-analysis');
            }
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = true;
            });
            updateReportPreview();
        }

        function deselectAllReportSections() {
            const checkboxes = ['report-project-info', 'report-cost-breakdown', 'report-workforce', 
                               'report-boq', 'report-unit-rates', 'report-mr-analysis'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            updateReportPreview();
        }

        // Export to Excel
        function exportToExcel() {
            const calc = state.calculations;
            const scopeOfWork = document.getElementById('scopeOfWork').value;
            
            // Create CSV content
            let csv = 'RGS Scaffolding Estimation Report\n\n';
            
            // Project Information
            csv += 'PROJECT INFORMATION\n';
            csv += `Serial Number,${state.reportSerialNumber}\n`;
            csv += `Report Type,${state.reportType === 'quotation' ? 'Quotation/Offer' : 'Internal Report'}\n`;
            csv += `Date,${new Date().toLocaleDateString()}\n`;
            csv += `Client,${state.projectInfo.clientName || 'N/A'}\n`;
            csv += `Project,${state.projectInfo.projectName || 'N/A'}\n`;
            csv += `Location,${state.projectInfo.location || 'N/A'}\n`;
            csv += `Scaffolding Type,${state.scaffoldingType}\n`;
            csv += `${calc.measurementUnit === 'm²' ? 'Platform Area' : 'Volume'},${calc.measurementValue.toFixed(2)} ${calc.measurementUnit}\n`;
            csv += `Total Weight,${(calc.totalWeight / 1000).toFixed(2)} Tons\n\n`;
            
            // Scope of Work
            if (scopeOfWork) {
                csv += 'SCOPE OF WORK\n';
                csv += `"${scopeOfWork.replace(/"/g, '""')}"\n\n`;
            }
            
            // Cost Summary
            csv += 'COST SUMMARY\n';
            csv += `Material Cost (${state.costOption}),${calc.materialCost.toFixed(2)}\n`;
            csv += `Installation Cost,${calc.totalLaborCost.toFixed(2)}\n`;
            csv += `Transportation,${calc.transportCost.toFixed(2)}\n`;
            csv += `Equipment & Tools,${calc.equipmentToolsCost.toFixed(2)}\n`;
            
            if (state.reportType === 'internal') {
                csv += `Direct Costs,${calc.directCosts.toFixed(2)}\n`;
                csv += `Overhead (${state.settings.overheadPercentage}%),${calc.overheadCost.toFixed(2)}\n`;
                csv += `Subtotal,${calc.subtotal.toFixed(2)}\n`;
                csv += `Profit (${state.settings.profitMargin}%),${calc.profitAmount.toFixed(2)}\n`;
            }
            
            csv += `Total Project Cost,${calc.totalCost.toFixed(2)}\n\n`;
            
            // Unit Rates
            csv += 'UNIT RATES\n';
            csv += `Material Unit Rate,${calc.materialUnitRate.toFixed(2)} per ${calc.measurementUnit}\n`;
            csv += `Installation Unit Rate,${calc.installationUnitRate.toFixed(2)} per ${calc.measurementUnit}\n`;
            csv += `Total Unit Rate,${calc.totalUnitRate.toFixed(2)} per ${calc.measurementUnit}\n\n`;
            
            // Workforce
            csv += 'WORKFORCE PLANNING\n';
            csv += `Scaffolders Required,${calc.scaffoldersRequired}\n`;
            csv += `Teams Required,${calc.teamsRequired}\n`;
            csv += `Project Duration,${calc.actualProjectDays} days\n`;
            csv += `Total Manhours,${calc.manhours.toFixed(2)} hours\n\n`;
            
            // BOQ
            csv += 'BILL OF QUANTITIES\n';
            csv += 'S/N,Description,Code,Qty,Length,Unit Wt,Total Wt,Purchase Rate,Hire/Day,Days,Total\n';
            
            state.boqItems.filter(item => item.quantity > 0).forEach((item, index) => {
                const amount = state.costOption === 'hire' 
                    ? item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration
                    : item.quantity * item.purchaseRate;
                
                csv += `${index + 1},${item.description},${item.materialCode},${item.quantity},${item.length},${item.unitWeight},${item.totalWeight.toFixed(2)},${item.purchaseRate.toFixed(2)},${item.adjustedDailyHireRate.toFixed(3)},${state.projectInfo.hireDuration},${amount.toFixed(2)}\n`;
            });
            
            csv += `\nTotal Weight (Kg),,,,,${calc.totalWeight.toFixed(0)}\n`;
            csv += `Total Amount,,,,,,,,,${calc.materialCost.toFixed(2)}\n`;
            
            if (state.reportType === 'internal') {
                csv += `\nMATERIAL RETURN ANALYSIS\n`;
                csv += `Material Return %,${calc.mrPercentage}%\n`;
                csv += `Projects to Break-even,${calc.mrPercentage > 0 ? Math.ceil(100 / calc.mrPercentage) : 'N/A'}\n`;
                csv += `Daily Hire Revenue,${(calc.totalProjectHireRevenue / state.projectInfo.hireDuration).toFixed(2)}\n`;
                csv += `Total Purchase Cost,${calc.totalPurchaseCost.toFixed(2)}\n`;
            }
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `RGS_Estimation_${state.reportSerialNumber}.csv`);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Generate report
        function generateReport() {
            const reportWindow = window.open('', '_blank');
            const calc = state.calculations;
            const isQuotation = state.reportType === 'quotation';
            
            // Get selected report sections
            const includeProjectInfo = document.getElementById('report-project-info').checked;
            const includeCostBreakdown = document.getElementById('report-cost-breakdown').checked;
            const includeWorkforce = document.getElementById('report-workforce').checked;
            const includeBoq = document.getElementById('report-boq').checked;
            const includeUnitRates = document.getElementById('report-unit-rates').checked;
            const includeMrAnalysis = !isQuotation && document.getElementById('report-mr-analysis').checked;
            
            // Get scope of work and terms
            const scopeOfWork = document.getElementById('scopeOfWork').value;
            const termsConditions = document.getElementById('termsConditions').value;
            
            // Calculate indirect workforce
            let indirectWorkforce = 0;
            Object.entries(state.indirectPersonnel).forEach(([role, data]) => {
                if (data.enabled) {
                    const quantity = role === 'supervisor' && !data.quantity ? 
                        (calc.supervisorsRequired || 1) : data.quantity;
                    indirectWorkforce += quantity;
                }
            });
            
            // Generate BOQ rows
            const boqRows = state.boqItems.filter(item => item.quantity > 0).map((item, index) => {
                const amount = state.costOption === 'hire' 
                    ? item.quantity * item.adjustedDailyHireRate * state.projectInfo.hireDuration
                    : item.quantity * item.purchaseRate;
                
                const hasDiscount = item.customDailyHireRate && item.customDailyHireRate !== item.baseDailyHireRate;
                const discountPercent = hasDiscount ? 
                    ((1 - (item.customDailyHireRate / item.baseDailyHireRate)) * 100).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${item.description}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.materialCode}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.quantity}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.length}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.unitWeight}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.totalWeight.toFixed(2)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                            ${item.purchaseRate.toFixed(2)}
                            ${!isQuotation ? `<div style="font-size: 10px; color: #666;">Daily: ${item.baseDailyHireRate.toFixed(3)}</div>` : ''}
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                            ${item.adjustedDailyHireRate.toFixed(3)}
                            ${hasDiscount && !isQuotation ? `<span style="color: red; font-size: 10px;">(${discountPercent}% off)</span>` : ''}
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${state.projectInfo.hireDuration}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                            ${formatSAR(amount)}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Generate workforce section
            const workforceSection = includeWorkforce ? `
                <div class="info-box page-break" style="margin-top: 20px;">
                    <h3>Workforce Planning</h3>
                    <p><strong>Scaffolders Required:</strong> ${calc.scaffoldersRequired} workers (${calc.teamsRequired} teams of ${state.projectInfo.teamSize})</p>
                    <p><strong>Project Duration:</strong> ${calc.actualProjectDays} days</p>
                    <p><strong>Total Manhours:</strong> ${calc.manhours.toFixed(2)} hours</p>
                    <p><strong>Working Schedule:</strong> 10 hours/day, 6 days/week</p>
                    ${indirectWorkforce > 0 && !isQuotation ? `<p><strong>Indirect Personnel:</strong> ${indirectWorkforce} people</p>` : ''}
                    <p><strong>Total Installation Cost:</strong> ${formatSAR(calc.totalLaborCost)}</p>
                    
                    <h4 style="margin-top: 15px;">Progressive Installation Summary</h4>
                    <table style="width: 100%; margin-top: 10px; font-size: 12px;">
                        <tr>
                            <th style="padding: 5px; border: 1px solid #ddd;">Metric</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">Daily</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">Weekly</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">Total</th>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Progress</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${(calc.measurementValue / calc.actualProjectDays).toFixed(2)} ${calc.measurementUnit}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${((calc.measurementValue / calc.actualProjectDays) * 6).toFixed(2)} ${calc.measurementUnit}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${calc.measurementValue.toFixed(2)} ${calc.measurementUnit}</td>
                        </tr>
                        ${!isQuotation ? `
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Cost</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatSAR(calc.directCosts / calc.actualProjectDays)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatSAR((calc.directCosts / calc.actualProjectDays) * 6)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatSAR(calc.directCosts)}</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">Revenue</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatSAR(calc.totalCost / calc.actualProjectDays)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatSAR((calc.totalCost / calc.actualProjectDays) * 6)}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${formatSAR(calc.totalCost)}</td>
                        </tr>
                    </table>
                    
                    <p style="margin-top: 10px; font-size: 11px;"><strong>Note:</strong> Progressive installation based on ${calc.scaffoldersRequired} scaffolders working at ${state.projectInfo.productivityRate} ${calc.measurementUnit}/hour per worker.</p>
                </div>
            ` : '';
            
            // Generate unit rates section
            const unitRatesSection = includeUnitRates ? `
                <div class="info-box" style="margin-top: 20px;">
                    <h3>Unit Rate Analysis</h3>
                    <p><strong>Material Unit Rate (${state.costOption}):</strong> ${formatSAR(calc.materialUnitRate)}/${calc.measurementUnit}</p>
                    ${state.costOption === 'hire' ? `<p><strong>Daily Material Unit Rate:</strong> ${formatSAR(calc.dailyMaterialUnitRate)}/${calc.measurementUnit}</p>` : ''}
                    <p><strong>Installation Unit Rate:</strong> ${formatSAR(calc.installationUnitRate)}/${calc.measurementUnit}</p>
                    <p><strong>Total Unit Rate:</strong> ${formatSAR(calc.totalUnitRate)}/${calc.measurementUnit}</p>
                </div>
            ` : '';
            
            // For quotations, combine overhead into installation costs
            const displayInstallationCost = isQuotation ? 
                calc.totalLaborCost + calc.overheadCost : calc.totalLaborCost;
            
            const reportHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${isQuotation ? 'Quotation' : 'Scaffolding Estimation Report'} - ${state.projectInfo.projectName || 'Project'}</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #676c6c; padding-bottom: 20px; }
                        .logo { display: flex; justify-content: center; align-items: center; gap: 5px; margin-bottom: 10px; }
                        .logo-box { padding: 5px 10px; font-weight: bold; color: white; border-radius: 3px; }
                        h1, h2, h3 { color: #333; margin: 10px 0; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background-color: #f0f0f0; font-weight: bold; text-align: left; padding: 10px; border: 1px solid #ddd; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .info-box { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
                        .summary-box { background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin: 20px 0; }
                        .cost-row { display: flex; justify-content: space-between; margin: 5px 0; }
                        .total-row { font-weight: bold; font-size: 1.1em; border-top: 2px solid #333; padding-top: 10px; margin-top: 10px; }
                        .terms-box { background-color: #f0f0f0; padding: 15px; margin-top: 30px; border-radius: 5px; }
                        @media print { .page-break { page-break-before: always; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">
                            <span class="logo-box" style="background-color: #676c6c;">R</span>
                            <span class="logo-box" style="background-color: #ff6b35;">G</span>
                            <span class="logo-box" style="background-color: #676c6c;">S</span>
                        </div>
                        <h1>RGS - Resa Gulf Scaffolding Co. Ltd.</h1>
                        <p>${isQuotation ? 'Scaffolding Quotation' : 'Scaffolding Estimation Report'}</p>
                        <p style="font-size: 12px;">info@rgsksa.com | +966 13 812 1111</p>
                        <p style="font-size: 11px; color: #666;">Serial No: ${state.reportSerialNumber} | Date: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    ${scopeOfWork ? `
                    <div class="info-box" style="margin-bottom: 20px;">
                        <h3>Scope of Work</h3>
                        <pre style="white-space: pre-wrap; font-family: Arial, sans-serif; font-size: 13px; line-height: 1.5;">${scopeOfWork}</pre>
                    </div>
                    ` : ''}
                    
                    ${includeProjectInfo ? `
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>Project Information</h3>
                            <p><strong>Client:</strong> ${state.projectInfo.clientName || 'N/A'}</p>
                            <p><strong>Project:</strong> ${state.projectInfo.projectName || 'N/A'}</p>
                            <p><strong>Location:</strong> ${state.projectInfo.location || 'N/A'}</p>
                            <p><strong>Date:</strong> ${new Date(state.projectInfo.date).toLocaleDateString()}</p>
                            <p><strong>Type:</strong> ${state.scaffoldingType.charAt(0).toUpperCase() + state.scaffoldingType.slice(1)} Scaffolding</p>
                        </div>
                        <div class="info-box">
                            <h3>Dimensions & Measurements</h3>
                            <p><strong>Length:</strong> ${state.dimensions.length || 0} m</p>
                            <p><strong>Width:</strong> ${state.scaffoldingType === 'independent' ? '1.5 (fixed)' : state.dimensions.width || 0} m</p>
                            <p><strong>Height:</strong> ${state.dimensions.height || 0} m${state.scaffoldingType === 'suspended' ? ' (ref only)' : ''}</p>
                            <p><strong>${calc.measurementUnit === 'm²' ? 'Platform Area' : 'Volume'}:</strong> ${calc.measurementValue.toFixed(2)} ${calc.measurementUnit}</p>
                            <p><strong>Total Weight:</strong> ${(calc.totalWeight / 1000).toFixed(2)} Tons</p>
                            ${!isQuotation ? `<p><strong>Purchase Cost/Ton:</strong> ${formatSAR(calc.purchasePerTon)}</p>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeCostBreakdown ? `
                    <div class="summary-box">
                        <h3>Cost Summary</h3>
                        <div class="cost-row">
                            <span>Material Cost (${state.costOption}):</span>
                            <span>${formatSAR(calc.materialCost)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Installation Cost:</span>
                            <span>${formatSAR(displayInstallationCost)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Transportation:</span>
                            <span>${formatSAR(calc.transportCost)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Equipment & Tools:</span>
                            <span>${formatSAR(calc.equipmentToolsCost)}</span>
                        </div>
                        ${!isQuotation ? `
                        <div class="cost-row">
                            <span>Sub-total (Direct Costs):</span>
                            <span>${formatSAR(calc.directCosts)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Overhead (${state.settings.overheadPercentage}%):</span>
                            <span>${formatSAR(calc.overheadCost)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Sub-total (Including Overhead):</span>
                            <span>${formatSAR(calc.subtotal)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Profit (${state.settings.profitMargin}%):</span>
                            <span>${formatSAR(calc.profitAmount)}</span>
                        </div>
                        ` : ''}
                        <div class="cost-row total-row">
                            <span>Total ${isQuotation ? 'Quotation' : 'Project'} Cost:</span>
                            <span>${formatSAR(calc.totalCost)}</span>
                        </div>
                        ${includeMrAnalysis ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <p><strong>Material Return % (MR%):</strong> <span style="color: ${
                                calc.mrPercentage >= 45 ? '#059669' :
                                calc.mrPercentage >= 30 ? '#ea580c' : '#dc2626'
                            }; font-size: 1.2em; font-weight: bold;">${calc.mrPercentage}%</span></p>
                            <p style="font-size: 12px; color: #666;">This project recovers ${calc.mrPercentage}% of the purchase investment. ${
                                calc.mrPercentage > 0 ? `Break-even after ${Math.ceil(100 / calc.mrPercentage)} similar projects.` : ''
                            }</p>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${workforceSection}
                    ${unitRatesSection}
                    
                    ${includeBoq ? `
                    <div class="page-break"></div>
                    
                    <h2>Bill of Quantities - ${state.scaffoldingType.charAt(0).toUpperCase() + state.scaffoldingType.slice(1)} Scaffolding</h2>
                    ${state.projectInfo.marketAdjustment !== 0 && !isQuotation ? 
                        `<p style="margin-bottom: 10px; color: #059669;"><strong>Hire Rate Adjustment Applied:</strong> ${state.projectInfo.marketAdjustment > 0 ? '+' : ''}${state.projectInfo.marketAdjustment}% (applies to hire rates only)</p>` : ''}
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: center;">S/N</th>
                                <th>Description</th>
                                <th style="text-align: center;">Code</th>
                                <th style="text-align: center;">Qty</th>
                                <th style="text-align: center;">Length</th>
                                <th style="text-align: center;">Unit Wt (kg)</th>
                                <th style="text-align: center;">Total Wt (kg)</th>
                                <th style="text-align: center;">Purchase (SAR)</th>
                                <th style="text-align: center;">Hire/Day (SAR)</th>
                                <th style="text-align: center;">Days</th>
                                <th style="text-align: right;">${state.costOption === 'hire' ? 'Total Hire' : 'Purchase Amount'} (SAR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${boqRows}
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; background-color: #f0f0f0;">
                                <td colspan="6" style="text-align: right;">Total Weight (Kg):</td>
                                <td style="text-align: center;">${calc.totalWeight.toFixed(0)}</td>
                                <td colspan="3" style="text-align: right;">Total Amount:</td>
                                <td style="text-align: right;">${formatSAR(calc.materialCost)}</td>
                            </tr>
                            ${!isQuotation ? `
                            <tr style="font-weight: bold; background-color: #f0f0f0;">
                                <td colspan="7" style="text-align: right;">Purchase Cost per Ton:</td>
                                <td colspan="4" style="text-align: right;">${formatSAR(calc.purchasePerTon)}</td>
                            </tr>
                            ` : ''}
                        </tfoot>
                    </table>
                    ` : ''}
                    
                    ${isQuotation && termsConditions ? `
                    <div class="terms-box">
                        <h3>Terms and Conditions</h3>
                        <pre style="white-space: pre-wrap; font-family: Arial, sans-serif; font-size: 12px;">${termsConditions}</pre>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 50px; text-align: center; color: #666; font-size: 12px;">
                        <p>Generated on ${new Date().toLocaleString()}</p>
                        <p>This is a computer-generated document</p>
                        ${isQuotation ? '<p><strong>This quotation is valid for 30 days from the date of issue</strong></p>' : ''}
                    </div>
                </body>
                </html>
            `;
            
            reportWindow.document.write(reportHtml);
            reportWindow.document.close();
            setTimeout(() => reportWindow.print(), 500);
        }

        // Email report
        function emailReport() {
            const subject = encodeURIComponent(`RGS Scaffolding ${state.reportType === 'quotation' ? 'Quotation' : 'Report'} - ${state.projectInfo.projectName || 'Project'}`);
            const body = encodeURIComponent(`Please find attached the scaffolding ${state.reportType === 'quotation' ? 'quotation' : 'estimation report'} for ${state.projectInfo.projectName || 'your project'}.\n\nSerial Number: ${state.reportSerialNumber}\nDate: ${new Date().toLocaleDateString()}\n\nBest regards,\nRGS Team`);
            
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Print report
        function printReport() {
            generateReport();
        }

        // Save settings
        function saveSettings() {
            // In a real application, this would save to localStorage or a backend
            alert('Settings saved successfully!');
        }

        // Reset all
        function resetAll() {
            if (confirm('Are you sure you want to reset all values? This action cannot be undone.')) {
                // Reset dimensions
                document.getElementById('length').value = '';
                document.getElementById('width').value = '';
                document.getElementById('height').value = '';
                
                // Reset project info
                document.getElementById('clientName').value = '';
                document.getElementById('projectName').value = '';
                document.getElementById('location').value = '';
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('productivityRate').value = '2.5';
                document.getElementById('teamSize').value = '4';
                document.getElementById('projectDuration').value = '';
                document.getElementById('hireDuration').value = '30';
                document.getElementById('marketAdjustment').value = '0';
                
                // Reset scaffolding type
                selectScaffoldingType('birdcage');
                
                // Reset cost option
                setCostOption('hire');
                
                // Generate new serial number
                generateSerialNumber();
                
                // Recalculate
                calculateAll();
            }
        }
    </script>
</body>
</html>